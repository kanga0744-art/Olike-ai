
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polli - Gen - AI Image Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ===== CSS VARIABLES & RESET ===== */
        :root {
            /* FIXED DARK THEME */
            --bg-color: #09090b; 
            --surface-color: #18181b; 
            --surface-color-rgb: 24, 24, 27; 
            --surface-hover: #27272a;
            --surface-hover-rgb: 39, 39, 42; 
            --border-color: #3f3f46;
            --primary-color: #6366f1; 
            --primary-color-rgb: 99, 102, 241;
            --primary-hover: #818cf8;
            --text-main: #f4f4f5; 
            --text-muted: #a1a1aa;
            --success: #10b981;
            --error: #ef4444;
            --radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --preview-bg: #000000;
            --modal-bg: #09090b;
            --gallery-gap: 1.5rem; 
            --gallery-action-btn-size: 24px; 
            --warning: orange; 
            --pollen-color: #ec4899; 
            
            /* Sidebar Width */
            --sidebar-width: 320px;
            --sidebar-gap: 20px; /* Jarak antara sidebar dan konten utama */
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --bg-color: #f4f4f5; 
            --surface-color: #ffffff; 
            --surface-color-rgb: 255, 255, 255; 
            --surface-hover: #e4e4e7;
            --surface-hover-rgb: 228, 228, 231; 
            --border-color: #d4d4d8;
            --primary-color: #6366f1; 
            --primary-color-rgb: 99, 102, 241;
            --primary-hover: #4f46e5;
            --text-main: #18181b; 
            --text-muted: #71717a;
            --preview-bg: #e4e4e7;
            --modal-bg: #f4f4f5;
            --warning: orange;
        }

        /* FIX: Make Header Logo Visible in Light Mode */
        [data-theme="light"] .logo img {
            filter: invert(1);
        }

        /* FIX: Ensure Generate Button Icon is Visible in Light Mode */
        [data-theme="light"] #floating-generate-btn img { 
            filter: invert(1); 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-family);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ===== HEADER ===== */
        header {
            height: 64px;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color); 
            display: flex;
            align-items: center;
            justify-content: space-between; 
            position: relative; 
            background: var(--surface-color); 
            flex-shrink: 0;
            z-index: 100; /* Lower than Modals */
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            z-index: 101; 
            position: relative;
        }

        .header-center {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px; /* Increased gap for better spacing */
            z-index: 100; 
            pointer-events: auto; 
            width: auto; 
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
            cursor: pointer;
        }

        /* UPDATED LOGO CSS */
        .logo img {
            height: 36px;
            width: auto;
            object-fit: contain;
            transition: transform 0.2s;
        }
        .logo:hover img { transform: scale(1.1); }
        
        .header-clock {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
            padding-right: 10px;
            border-right: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            height: 20px;
            font-weight: 600;
        }
        
        .pollen-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-main);
            background: rgba(236, 72, 153, 0.1);
            border: 1px solid rgba(236, 72, 153, 0.3);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            cursor: help;
            white-space: nowrap;
            transition: opacity 0.3s;
        }
        .pollen-icon { color: var(--pollen-color); }
        
        .reset-timer {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-left: 6px;
            font-weight: 500;
            font-family: monospace;
            display: inline-block;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
            background: var(--bg-color); 
            padding: 4px 8px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--error);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .status-dot.active {
            background-color: var(--success);
            box-shadow: 0 0 6px var(--success);
        }

        #header-private-gallery-btn, #theme-toggle-btn, #lang-toggle-btn, .sidebar-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 0 0.5rem;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            gap: 6px;
            transition: 0.2s;
            position: relative; 
            z-index: 102; 
            border-radius: 6px;
            font-weight: 600;
        }
        
        #header-private-gallery-btn:hover, #theme-toggle-btn:hover, #lang-toggle-btn:hover, .sidebar-toggle-btn:hover {
            background: var(--surface-hover);
            color: var(--text-main);
        }
        
        .sidebar-toggle-btn.active {
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }
        
        #header-private-gallery-btn.active {
            background: var(--surface-hover);
            color: var(--primary-color);
        }
        
        #theme-toggle-btn i, #lang-toggle-btn i {
            font-size: 1.1rem;
            color: var(--text-main);
        }
        
        #lang-toggle-btn {
            font-size: 0.85rem;
            font-weight: 700;
            width: 32px;
        }

        /* ===== BOTTOM FLOATING BAR ===== */
        #bottom-floating-bar {
            position: fixed;
            bottom: 45px; /* UPDATED: Raised to prevent clipping on hover */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 90;
            padding: 10px 20px;
            border-radius: 50px;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        #bottom-floating-bar > * {
            pointer-events: auto;
        }

        body:has(.modal.active) #bottom-floating-bar {
            display: none !important;
        }

        #floating-generate-btn {
            position: relative;
            bottom: auto;
            left: auto;
            transform: none;
            width: 60px; /* Reduced Size */
            height: 60px; /* Reduced Size */
            padding: 0;
            border-radius: 12px; /* Soft square corners */
            background-color: transparent; /* Transparent Background */
            border: none; /* No Border */
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; /* Reduced Font Size */
            box-shadow: none; /* No Shadow */
            cursor: pointer;
            transition: transform 0.2s;
            overflow: visible; 
        }
        #floating-generate-btn img {
            width: 100%; /* Fill the container */
            height: 100%;
            object-fit: contain;
            transition: transform 0.2s;
        }
        #floating-generate-btn:hover {
            transform: scale(1.15); 
            background-color: transparent;
            box-shadow: none;
            border: none;
        }
        #floating-generate-btn:hover img {
            transform: scale(1.1);
        }
        #floating-generate-btn:active {
            transform: scale(0.95);
        }
        #floating-generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .gallery-nav-btn {
            position: relative;
            top: auto;
            left: auto;
            right: auto;
            transform: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .gallery-nav-btn:hover {
            background: var(--surface-hover);
            transform: scale(1.1);
            color: var(--primary-color);
        }
        
        /* ===== MAIN LAYOUT ===== */
        main {
            display: flex;
            flex: 1;
            height: calc(100vh - 64px);
            overflow: hidden;
            position: relative;
            z-index: 1; 
            padding: 0;
        }

        /* ===== FLOATING SIDEBARS ===== */
        .floating-sidebar {
            position: fixed;
            top: 74px; /* Below header with some gap */
            bottom: 20px;
            width: var(--sidebar-width);
            background-color: rgba(var(--surface-color-rgb), 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2.5rem 1.5rem; /* Increased Vertical Padding */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            flex-shrink: 0;
            z-index: 50; /* Above canvas, below modals/header */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .floating-sidebar::-webkit-scrollbar { display: none; }

        .floating-sidebar.left {
            left: 10px;
            transform: translateX(0);
        }
        .floating-sidebar.left.hidden {
            transform: translateX(-110%);
            opacity: 0;
            pointer-events: none;
        }

        .floating-sidebar.right {
            right: 10px;
            transform: translateX(0);
        }
        .floating-sidebar.right.hidden {
            transform: translateX(110%);
            opacity: 0;
            pointer-events: none;
        }

        /* Responsive Sidebars */
        @media (max-width: 900px) {
            .floating-sidebar {
                width: 280px;
            }
        }
        
        @media (max-width: 600px) {
            .floating-sidebar {
                width: calc(100% - 20px);
                top: 70px;
                bottom: 90px; /* Space for floating bar */
                background-color: var(--surface-color); /* Solid bg on mobile for performance */
                padding: 1.5rem; /* Adjusted for mobile */
            }
        }
        
        /* SIDEBAR TABS */
        .sidebar-tabs {
            display: flex;
            background: var(--bg-color);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            gap: 4px;
            margin-bottom: 5px;
        }
        .tab-btn {
            flex: 1;
            padding: 0.6rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: 0.2s;
            white-space: nowrap;
        }
        .tab-btn:hover {
            color: var(--text-main);
            background: rgba(255,255,255,0.05);
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* CONTENT PANELS (Used for switching content based on tab) */
        .content-panel {
            display: none;
            flex-direction: column;
            gap: 1.25rem;
        }
        .content-panel.active {
            display: flex;
        }

        /* ===== MIXER UI STYLES ===== */
        .mixer-container {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-color);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: 0.3s;
        }
        .mixer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .mixer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .mixer-content {
            display: none;
            flex-direction: column;
            gap: 8px;
            animation: slideDown 0.3s ease-out;
        }
        
        /* Updated mixer tag area for split view */
        .mixer-tag-area {
            overflow-y: auto;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
        }
        .mixer-tag-area::-webkit-scrollbar { width: 4px; }
        .mixer-tag-area::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }

        .mixer-tag {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .mixer-tag:hover {
            border-color: var(--primary-color);
            color: var(--text-main);
            transform: translateY(-1px);
        }
        
        /* Selected Items Style */
        .selected-item.mixer-tag {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary-color);
            color: var(--text-main);
        }
        .selected-item.mixer-tag:hover {
            background: rgba(239, 68, 68, 0.2); /* Red tint on hover to indicate removal */
            border-color: var(--error);
        }

        .mixer-empty-text {
            width: 100%;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 20px;
            font-style: italic;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .preview-area {
            flex: 1;
            background-color: var(--surface-color); /* Restored to surface color for Card look */
            border-radius: 24px; /* Restored radius */
            border: 1px solid var(--border-color); /* Restored border */
            
            /* UPDATED LAYOUT LOGIC FOR CENTERED PREVIEW */
            /* Margin left/right = Sidebar Width + Gap */
            /* Default state assumes both sidebars are open (set by Javascript class) */
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            margin-left: calc(var(--sidebar-width) + var(--sidebar-gap)); 
            margin-right: calc(var(--sidebar-width) + var(--sidebar-gap));
            
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 0;
            min-width: 0;
            overflow: hidden;
            transition: background-color 0.3s, margin 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Added margin transition */
            z-index: 1;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        /* Classes controlled by JS to adjust preview width */
        body.left-closed .preview-area {
            margin-left: 1rem;
        }
        
        body.right-closed .preview-area {
            margin-right: 1rem;
        }
        
        @media (max-width: 900px) {
            /* Adjust sidebar width variable implicitly handled by CSS variable logic if we updated it via JS, 
               but since sidebars are fixed pixel width in CSS, we rely on the transition. */
        }
        
        @media (max-width: 600px) {
            .preview-area {
                /* On mobile, sidebars overlay, so preview is always full width */
                margin: 0 !important;
                border-radius: 0;
                border: none;
            }
        }
        
        #results-gallery-container {
            display: flex; 
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: center;
            gap: var(--gallery-gap);
            width: 100%;
            height: 100%;
            padding: 2rem 60px; /* Padding for scroll buttons */
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            
            /* ADDED: Position relative and z-index for stacking above placeholder */
            position: relative;
            z-index: 10;
        }
        #results-gallery-container::-webkit-scrollbar {
            display: none;
        }
        
        .loader {
            display: none;
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-bottom-color: var(--primary-color);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            position: absolute;
            z-index: 30;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        #loading-status-text {
            display: none;
            position: absolute;
            top: calc(50% + 40px);
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-muted);
            font-size: 0.9rem;
            font-family: monospace;
            z-index: 30;
            text-align: center;
            width: 100%;
        }

        @keyframes rotation {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ===== CONTROLS ===== */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .value-display {
            color: var(--text-main);
            font-family: monospace;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            background-color: var(--surface-color); 
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 0.75rem;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: 0.2s;
            width: 100%;
        }
        
        textarea {
            -ms-overflow-style: none;
            scrollbar-width: none; 
            min-height: 80px;
            resize: vertical;
        }
        textarea::-webkit-scrollbar {
            display: none; 
        }

        input[type="number"]:disabled,
        select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: var(--surface-hover);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .row {
            display: flex;
            gap: 1rem;
        }

        .row > * {
            flex: 1;
        }

        .input-with-btn {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .input-with-btn input {
            flex: 1;
            margin-bottom: 0;
        }
        .input-with-btn select {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn, .input-with-btn button {
            padding: 0.75rem 1rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 12px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
            font-weight: 500;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:hover, .input-with-btn button:hover {
            background-color: var(--surface-hover);
            border-color: var(--text-muted);
        }
        .btn-primary, .input-with-btn button.btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .btn-primary:hover, .input-with-btn button.btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--surface-hover);
            border-radius: 3px;
            margin-top: 8px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 0 2px var(--bg-color);
            transition: transform 0.1s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        input[type="range"]:disabled::-webkit-slider-thumb {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        
        input[type="range"]:disabled {
            background: var(--border-color);
        }
        
        /* ===== IMAGE PREVIEW ===== */
        #results-gallery-container .image-wrapper {
            height: auto;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer; 
            transition: transform 0.2s, border-color 0.3s;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: flex-start; 
            flex-shrink: 0;
            min-height: 100px; 
            background-color: var(--surface-hover); /* UPDATED: Changed from transparent */
            border: 1px solid transparent; /* UPDATED: Transparent initially */
            padding: 0; /* ZERO PADDING */
            outline: none !important; 
            width: auto; 
            max-width: 90vh;
        }
        
        #results-gallery-container .image-wrapper.loaded {
            border-color: var(--border-color); /* UPDATED: Border appears when loaded */
        }

        .image-wrapper img {
            display: block;
            width: auto; 
            height: auto;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 8px; 
            outline: none !important; 
        }

        #results-gallery-container .image-wrapper[data-orientation="square"] img {
            max-height: 450px;
        }
        #results-gallery-container .image-wrapper[data-orientation="landscape"] img {
            max-height: 350px;
        }
        #results-gallery-container .image-wrapper[data-orientation="portrait"] img {
            max-height: 500px;
        }

        @media (max-width: 900px) {
             #results-gallery-container .image-wrapper img {
                max-height: 50vh;
            }
        }

        .image-wrapper:hover {
            transform: scale(1.01);
        }

        .placeholder {
            position: absolute;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            pointer-events: none;
            background: transparent;
            padding: 0; /* UPDATED: Remove Padding */
            border-radius: var(--radius);
            border: none; /* UPDATED: Remove Border */
            box-shadow: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            justify-content: center;
            
            /* ADDED: Ensure it stays below gallery */
            z-index: 0;
        }
        
        .placeholder img {
            width: 180px; /* Logo Size */
            height: auto;
            object-fit: contain;
            filter: brightness(0.85); /* Slightly darker as requested */
            margin-bottom: 20px;
            transition: filter 0.3s;
        }

        .hint-text {
            position: absolute;
            bottom: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }

        .image-wrapper > img:hover + .hint-text,
        .image-wrapper.loaded > img + .hint-text { 
            opacity: 1;
        }
        .image-wrapper:hover .hint-text {
            opacity: 1;
        }

        /* ===== ACTION BUTTONS ===== */
        #results-gallery-container .image-actions-bar,
        #private-gallery-modal .image-actions-bar {
            position: absolute;
            top: 6px;
            right: 6px;
            left: auto;
            bottom: auto;
            width: auto;
            height: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px); 
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #results-gallery-container .image-wrapper:hover .image-actions-bar,
        #private-gallery-modal .image-wrapper:hover .image-actions-bar {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }
        
        @media (max-width: 900px) {
             #results-gallery-container .image-wrapper .image-actions-bar,
             #private-gallery-modal .image-wrapper .image-actions-bar {
                opacity: 1;
                transform: none;
                pointer-events: auto;
                background: rgba(0, 0, 0, 0.6);
            }
        }

        #results-gallery-container .gallery-action-btn,
        #private-gallery-modal .gallery-action-btn {
            background: transparent;
            border: none;
            color: #ffffff;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: none;
        }

        #results-gallery-container .gallery-action-btn:hover,
        #private-gallery-modal .gallery-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* ===== MODAL STYLES (UPDATED Z-INDEX) ===== */
        .modal {
            position: fixed;
            top: 64px; 
            left: 0;
            width: 100%;
            height: calc(100vh - 64px); 
            background: var(--modal-bg); 
            z-index: 2000; /* Higher than header */
            display: none; 
            flex-direction: column;
        }

        .modal.active {
            display: flex; 
        }
        
        .modal .modal-content-wrapper { 
            background: var(--bg-color); 
            border: none; 
            color: var(--text-main);
            border-radius: 0;
            box-shadow: none; 
            margin: auto; 
            max-width: 100%; 
            width: 100%;
            max-height: 100%; 
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        .modal-header {
            height: 64px;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-main);
            flex-shrink: 0; 
            position: relative; 
        }

        .modal-body {
            flex: 1;
            position: relative;
            background: var(--bg-color); 
            overflow: hidden;
            padding: 0; 
        }
        
        /* SPLIT LAYOUT FOR MODALS */
        .modal-split-layout {
            display: flex;
            width: 100%;
            height: 100%;
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            gap: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .modal-split-sidebar {
            width: 310px;
            flex-shrink: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            padding-top: 0.5rem;
            background: transparent;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .modal-split-sidebar::-webkit-scrollbar { display: none; }

        .modal-split-preview {
            flex: 1;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-back-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            margin-bottom: 1rem;
            width: fit-content;
        }
        .modal-back-btn:hover {
            background: var(--surface-hover);
            color: var(--text-main);
            border-color: var(--primary-color);
        }

        /* Private Gallery Content */
        #private-gallery-content {
            background-color: transparent;
            border: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center; 
            align-content: flex-start;
            gap: 1.5rem;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        
        #private-gallery-modal .image-wrapper {
            background-color: var(--surface-hover); /* UPDATED: Changed from transparent */
            border: 1px solid transparent; /* UPDATED: Initial border transparent */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            cursor: pointer; 
            max-height: 500px; 
            flex: 0 0 calc(33.33% - 1.5rem * 2 / 3);
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center; 
            padding: 0; /* ZERO PADDING */
            transition: border-color 0.3s;
        }
        
        #private-gallery-modal .image-wrapper.loaded {
            border-color: var(--border-color); /* UPDATED: Visible border on load */
        }
        
        #private-gallery-modal .image-wrapper img {
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            background: transparent; /* TRANSPARENT BG */
        }

        /* Adjust sizing logic slightly to allow widths to be flexible */
        #private-gallery-modal .image-wrapper[data-orientation="landscape"] {
            flex: 0 0 100%; 
            max-width: 700px; 
            max-height: 450px; 
        }
        #private-gallery-modal .image-wrapper[data-orientation="portrait"] {
            flex: 0 0 calc(33.33% - 1.5rem * 2 / 3); 
            max-width: 250px; 
            max-height: 600px; 
        }
        
        #private-gallery-placeholder {
            position: absolute !important;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            border: none !important;
        }

        @media (max-width: 900px) { 
            .modal-split-layout {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
                overflow-y: auto;
            }
            .modal-split-sidebar {
                width: 100%;
                height: auto;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 1rem;
            }
            .modal-split-preview {
                min-height: 400px;
                border-radius: 16px;
                padding: 1rem;
                overflow: visible;
            }
            
            #private-gallery-modal .image-wrapper {
                flex: 0 0 calc(50% - 1.5rem / 2); 
                max-width: 350px;
                max-height: 550px;
            }
            #private-gallery-modal .image-wrapper[data-orientation="landscape"] {
                flex: 0 0 100%; 
                max-width: 450px; 
                max-height: 350px;
            }
            #private-gallery-modal .image-wrapper[data-orientation="portrait"] {
                flex: 0 0 calc(50% - 1.5rem / 2); 
                max-width: 300px; 
                max-height: 600px;
            }
        }
        @media (max-width: 680px) {
            #private-gallery-modal .image-wrapper {
                flex: 0 0 100%; 
                max-width: 300px;
                max-height: 500px;
            }
            #private-gallery-modal .image-wrapper[data-orientation="landscape"] {
                flex: 0 0 100%;
                max-width: 300px;
                max-height: 250px;
            }
            #private-gallery-modal .image-wrapper[data-orientation="portrait"] {
                flex: 0 0 100%;
                max-width: 250px;
                max-height: 550px;
            }
        }

        /* ===== I2P & I2I Specifics ===== */
        
        .i2p-model-toggle {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
            background: var(--surface-color);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .i2p-model-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .i2p-model-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .i2p-model-btn:hover:not(.active) {
            background: var(--surface-hover);
            color: var(--text-main);
        }
        
        .grounding-links {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }
        .grounding-links a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .grounding-links a:hover {
            text-decoration: underline;
        }

        /* I2I Multi-Image Gallery Styles - Sidebar Version */
        .i2i-input-area {
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        .i2i-input-area label {
            margin-bottom: 5px; 
        }
        .i2i-images-list {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 12px;
            padding-bottom: 8px;
            min-height: 100px; 
        }
        .i2i-images-list::-webkit-scrollbar {
            height: 6px;
        }
        .i2i-images-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        .i2i-image-item {
            position: relative;
            flex: 0 0 auto; 
            width: auto;
            height: 90px; 
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            max-width: 140px;
        }
        .i2i-image-item img {
            width: auto;
            height: 100%;
            object-fit: contain;
        }
        .i2i-remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
        }
        .i2i-remove-btn:hover {
            background: var(--error);
        }
        
        .close-overlay-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .close-overlay-btn:hover {
            background-color: var(--error);
        }
        
        /* I2I INPUT AREA ADJUSTMENT */
        #i2iInputGallery {
            min-height: 100px;
        }
        
        /* I2P Layout Adjustment (Deprecating old classes for new flex layout) */
        #uploadedImageDisplay {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        /* EDITOR MODAL UPDATES (Split Layout) */
        #editor-modal .modal-body {
            padding: 0;
        }
        
        #editor-modal .modal-split-preview {
            background-color: #000; /* Dark background for canvas specifically */
            border: 1px solid var(--border-color);
            padding: 0; /* Remove padding to maximize canvas */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #editor-image {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        
        .editor-controls {
            display: flex;
            flex-direction: column; /* Vertical stack */
            gap: 1.5rem;
            width: 100%;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }

        .tool-btns {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            justify-content: flex-start;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 80px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000; /* Highest priority */
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(var(--surface-color-rgb), 0.9); /* Translucent */
            backdrop-filter: blur(10px); /* Glass effect */
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 10px 20px;
            border-radius: 50px; /* Pill Shape */
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            pointer-events: auto;
        }

        .toast.error { border: 1px solid var(--error); color: var(--error); }
        .toast.success { border: 1px solid var(--success); color: var(--success); }
        .toast.warning { border: 1px solid orange; color: orange; }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translate(0, 20px) scale(0.9); }
            to { opacity: 1; transform: translate(0, 0) scale(1); }
        }
        
        /* ===== INFO MODAL STYLES ===== */
        .info-grid {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 12px;
            font-size: 0.9rem;
        }
        .info-label {
            color: var(--text-muted);
            font-weight: 600;
            text-align: right;
        }
        .info-value {
            color: var(--text-main);
            word-break: break-word;
            font-family: monospace;
            background: var(--surface-color);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        /* NEW STYLES FOR COLLAPSIBLE PROMPT */
        .info-value.prompt-toggle {
            max-height: 80px; /* Limit height by default (~3-4 lines) */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .info-value.prompt-toggle:hover {
            background-color: var(--surface-hover);
            border-color: var(--primary-color);
        }
        .info-value.prompt-toggle.expanded {
            max-height: 400px; /* Expand enough for long prompts */
            overflow-y: auto;
            display: block; /* Remove -webkit-box behavior */
            -webkit-line-clamp: unset;
        }
        
        #info-modal {
            z-index: 3000 !important; 
        }
        
        /* PREVIEW MODAL Z-INDEX FIX & CANVAS ROUNDED */
        #image-preview-modal {
            z-index: 4000 !important; 
            background: rgba(0,0,0,0.9);
            /* Ensure it covers full screen correctly */
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        #image-preview-modal.active {
            display: flex;
        }
        
        #image-preview-modal .modal-content-wrapper {
            background: transparent;
            border: none;
            box-shadow: none;
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            margin: 0;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Allow clicks to pass to close */
        }

        .preview-canvas-container {
            background-color: transparent; /* TRANSPARENT BG */
            border: none; /* NO BORDER */
            border-radius: 24px;
            padding: 0; /* ZERO PADDING */
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: none; /* NO SHADOW */
            pointer-events: auto; /* Re-enable clicks */
        }
        
        .preview-canvas-container img {
            max-width: 100%;
            max-height: 90vh; /* Adjusted for no padding */
            object-fit: contain;
            border-radius: 12px;
            border: 1px solid var(--border-color); /* ADDED */
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); /* MOVED HERE */
            background: transparent;
        }
        
        /* NEW STYLES FOR FIXES */
        #editor-modal {
            z-index: 3500 !important; /* Higher than gallery (2000) */
        }
        
        .close-preview-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .close-preview-btn:hover {
            background-color: var(--error);
            color: white;
            border-color: var(--error);
            transform: scale(1.1);
        }
        
        /* UI SWITCH STYLES (Used for NSFW and Enhance) */
        .ui-switch {
            position: relative;
            display: inline-block;
            width: 40px; 
            height: 24px; 
        }
        .ui-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border-color); 
            transition: .3s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px; 
            width: 18px; 
            left: 3px; 
            bottom: 3px; 
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(16px); 
        }

        /* DISABLED STATE STYLE */
        .ui-switch input:disabled + .slider {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* API STATUS ICON STYLE */
        #api-key-status-icon {
            transition: color 0.3s;
            margin-left: 5px;
            color: var(--text-muted); /* Inactive state */
        }
        #api-key-status-icon.active {
            color: var(--success) !important; 
            /* Removed text-shadow */
        }
        
        /* Get API Link Style */
        .get-api-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <!-- Left Group: Clock & Stats -->
        <div class="header-left">
            <!-- Realtime Clock -->
            <span id="header-clock" class="header-clock" data-i18n="clock_wita">WITA</span>
            
            <!-- Pollen Dashboard -->
            <div class="pollen-status" id="pollen-status-display" title="Tier: Flower (Resets Daily)" data-i18n-title="pollen_tooltip">
                <span class="pollen-icon"></span>
                <span id="pollen-count-display">10.00</span>
                <button id="refresh-balance-btn" style="background:none; border:none; cursor:pointer; color:var(--text-main); margin-left:5px; font-size:0.8rem;" title="Sync Balance"><i class="fas fa-sync-alt"></i></button>
                <span class="reset-timer" id="reset-timer-display" title="Countdown to Daily Reset (19:20 Local Time)" data-i18n-title="reset_timer"> --h --m --s</span>
            </div>
        </div>
        
        <!-- Center Group: Logo & Toggles -->
        <div class="header-center">
            <button class="sidebar-toggle-btn active" id="toggle-left-sidebar" title="Toggle Input Sidebar" data-i18n-title="sidebar_input">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- UPDATED LOGO -->
            <div class="logo" id="header-logo-btn" title="Back to Main Generator" data-i18n-title="back_home">
                <img src="https://user.uploads.dev/file/f2c1c066214c9cb7fa6934e01a613020.png" alt="Pollinations" style="height: 36px; width: auto; object-fit: contain;">
            </div>
            
            <button class="sidebar-toggle-btn active" id="toggle-right-sidebar" title="Toggle Settings Sidebar" data-i18n-title="sidebar_settings">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>

        <!-- Right Group: Theme & Nav Buttons -->
        <div class="header-right">
            <button id="theme-toggle-btn" title="Toggle Light/Dark Mode" data-i18n-title="toggle_theme">
                <i class="fas fa-moon"></i>
            </button>
            <!-- Language Toggle Button -->
            <button id="lang-toggle-btn" title="Switch Language" data-i18n-title="toggle_lang">EN</button>
            <button id="header-private-gallery-btn" title="Olike">
                Olike
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- LEFT SIDEBAR: INPUTS & CREATIVITY -->
        <aside class="floating-sidebar left" id="sidebar-left">
            <div class="control-group">
                <label for="pollinations-api-key-input" style="display:flex; justify-content:space-between; align-items:center;">
                    <a href="https://enter.pollinations.ai/authorize?redirect_url=https://olikeai.netlify.app" target="_blank" class="get-api-link" style="color: var(--primary-color); text-decoration:none; display:flex; align-items:center; gap:6px;">
                        <span data-i18n="get_api_key">Get API Key</span> <i class="fas fa-external-link-alt" style="font-size:0.8em"></i>
                    </a>
                    <i class="fas fa-key" id="api-key-status-icon"></i>
                </label>
                <input type="password" id="pollinations-api-key-input" placeholder="Paste API Key here" data-i18n-placeholder="paste_api_key">
            </div>

            <!-- TABS -->
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="t2i" id="tab-t2i-btn" data-i18n="tab_t2i">T2I</button>
                <button class="tab-btn" data-tab="i2i" id="tab-i2i-btn" data-i18n="tab_i2i">I2I</button>
                <button class="tab-btn" data-tab="i2p" id="tab-i2p-btn" data-i18n="tab_i2p">I2P</button>
            </div>

            <!-- SHARED / T2I SPECIFIC INPUTS -->
            <div id="left-t2i-panel" class="content-panel active">
                <!-- AI ASSISTANT -->
                <div class="control-group">
                    <label style="display:flex; justify-content:space-between; align-items:center;">
                        <span data-i18n="ai_assistant">AI Assistant</span>
                        <span style="font-size:0.7rem; color:var(--text-muted); font-weight:normal;">Perchance</span>
                    </label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <textarea id="ai-assistant-input" placeholder="Describe what you want..." data-i18n-placeholder="describe_what_you_want" style="flex: 1; min-height: 86px; height: 86px; resize: none; font-size: 0.85rem; padding: 8px;"></textarea>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button id="ai-generate-btn" class="btn" title="Generate Prompt" data-i18n-title="gen_prompt" style="width: 40px; height: 40px; padding: 0; justify-content: center; flex-shrink: 0; border-radius: 10px;"><i class="fas fa-lightbulb" style="color: #fbbf24;"></i></button>
                            <button id="ai-remix-btn" class="btn" title="Remix Prompt" data-i18n-title="remix_prompt" style="width: 40px; height: 40px; padding: 0; justify-content: center; flex-shrink: 0; border-radius: 10px;"><i class="fas fa-random"></i></button>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="prompt" data-i18n="prompt">Prompt</label>
                    <textarea id="prompt" placeholder="Describe your imagination..." data-i18n-placeholder="describe_imagination" required></textarea>
                </div>

                <div class="control-group">
                    <label for="negative_prompt" data-i18n="negative_prompt">Negative Prompt</label>
                    <textarea id="negative_prompt" placeholder="What to avoid..." data-i18n-placeholder="what_to_avoid" style="min-height: 60px;"></textarea>
                </div>

                <div class="row">
                    <div class="control-group">
                        <label data-i18n="aspect_ratio">Aspect Ratio</label>
                        <select id="aspect-ratio">
                            <option value="1:1" data-i18n="opt_square">1:1 Square</option>
                            <option value="4:3" data-i18n="opt_standard">4:3 Standard</option>
                            <option value="16:9" data-i18n="opt_widescreen">16:9 Widescreen</option>
                            <option value="9:16" selected data-i18n="opt_portrait">9:16 Portrait</option>
                            <option value="custom" data-i18n="opt_custom">Custom</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="control-group">
                        <label><span data-i18n="width">Width</span> <span class="value-display" id="width-display">1024</span></label>
                        <input type="number" id="width" value="1024" min="200" max="2048" step="16" disabled>
                    </div>
                    <div class="control-group">
                        <label><span data-i18n="height">Height</span> <span class="value-display" id="height-display">1024</span></label>
                        <input type="number" id="height" value="1024" min="200" max="2048" step="16" disabled>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="model">Model</label>
                    <select id="image-model-select">
                        <option value="flux">flux - 0.0002 $ (Best)</option>
                        <option value="klein-large">FLUX.2 Klein 9B - 0.012 $</option>
                        <option value="klein">FLUX.2 Klein 4B - 0.008 $</option>
                        <option value="zimage" selected>zimage - 0.0002 $</option>
                        <option value="seedream">Seedream 4.0 - 0.03 $</option>
                        <option value="nanobanana">nanobanana - 0.04 $</option>
                        <option value="kontext">kontext - 0.04 $</option>
                    </select>
                </div>
            </div>

            <!-- I2I SPECIFIC INPUTS -->
            <div id="left-i2i-panel" class="content-panel">
                <div class="i2i-input-area" style="position: relative;">
                    <label data-i18n="input_images">Input Images</label>
                    <div id="i2iInputGallery" class="i2i-images-list" style="display:none;"></div>
                    <div id="i2i-empty-placeholder" style="text-align:center; padding:10px; color:var(--text-muted); font-size:0.8rem; border:1px dashed var(--border-color); border-radius:6px; margin-bottom:8px;" data-i18n="no_images_added">
                        No images added
                    </div>

                    <div style="display:flex; gap:8px; position:relative; z-index:5;">
                        <button class="btn" id="i2iUrlBtn" style="flex:1; cursor:pointer;"><i class="fas fa-link"></i> <span data-i18n="add_url">Add URL</span></button>
                        <button class="btn" id="clearI2IInputBtn" style="flex:0.5; color:var(--error); border-color:var(--error); display:none;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div class="control-group">
                    <label for="i2iPromptInput" data-i18n="prompt">Prompt</label>
                    <textarea id="i2iPromptInput" placeholder="Describe changes..." data-i18n-placeholder="describe_changes" required></textarea>
                </div>
                
                <div class="control-group">
                    <label for="i2iNegPromptInput" data-i18n="negative_prompt">Negative Prompt</label>
                    <textarea id="i2iNegPromptInput" placeholder="What to avoid..." data-i18n-placeholder="what_to_avoid" style="min-height: 60px;"></textarea>
                </div>

                <div class="row">
                    <div class="control-group">
                        <label data-i18n="ratio">Ratio</label>
                        <select id="i2i-aspect-ratio">
                            <option value="1:1" data-i18n="opt_square">1:1 Square</option>
                            <option value="4:3" data-i18n="opt_standard">4:3 Standard</option>
                            <option value="16:9" data-i18n="opt_widescreen">16:9 Wide</option>
                            <option value="9:16" selected data-i18n="opt_portrait">9:16 Portrait</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="model">Model</label>
                    <select id="i2i-model-select">
                        <option value="klein-large">FLUX.2 Klein 9B - 0.012 $</option>
                        <option value="klein">FLUX.2 Klein 4B - 0.008 $</option>
                        <option value="seedream" selected>seedream - 0.03 $</option>
                        <option value="kontext">kontext - 0.04 $</option>
                        <option value="seedream-pro">seedream-pro - 0.04 $</option>
                        <option value="gptimage">gptimage - 0.06 $</option>
                        <option value="nanobanana-pro">nanobanana-pro - 0.14 $</option>
                    </select>
                </div>
                
                <!-- Moved I2I Strength here as it's critical input -->
                <div class="control-group">
                    <label><span data-i18n="strength">Strength</span> <span id="i2i-guidance-val" class="value-display">3.5</span></label>
                    <input type="range" id="i2i-guidance" min="1" max="20" step="0.5" value="3.5">
                </div>
            </div>

            <!-- I2P SPECIFIC INPUTS -->
            <div id="left-i2p-panel" class="content-panel">
                <div class="i2p-model-toggle">
                    <button class="btn i2p-model-btn active" data-model="fast" id="i2p-model-fast-btn" data-i18n="fast">Fast</button>
                    <button class="btn i2p-model-btn" data-model="detailed" id="i2p-model-detailed-btn" data-i18n="detailed">Detailed</button>
                </div>

                <div class="control-group">
                    <label for="imageToTextInput" data-i18n="instructions">Instructions</label>
                    <textarea id="imageToTextInput" placeholder="E.g., 'Describe the main subject', 'What lighting?'" data-i18n-placeholder="instructions_placeholder" style="min-height: 80px;"></textarea>
                </div>

                <div class="i2p-upload-options" style="display:flex; flex-direction:column; gap:8px;">
                    <input type="file" id="imageUploadEl" accept="image/*" style="display:none;">
                    <div style="display:flex; gap:8px;">
                        <button class="btn" id="i2p-upload-btn" style="flex:1;"><i class="fas fa-upload"></i> <span data-i18n="upload">Upload</span></button>
                        <button class="btn" id="i2p-url-btn" style="flex:1;"><i class="fas fa-link"></i> <span data-i18n="url">URL</span></button>
                    </div>
                    
                    <div id="imagePreviewContainer" style="display:none; width: 100%; justify-content: center; align-items: center; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; margin-top: 5px;">
                        <img id="uploadedImageDisplay" style="max-width: 100%; max-height: 150px; object-fit: contain; border-radius: 4px;">
                    </div>
                </div>

                <div class="control-group" style="margin-top: 10px;">
                    <label for="imageToText" data-i18n="result">Result</label>
                    <textarea id="imageToText" style="min-height:150px; font-family: monospace; font-size: 0.85rem;" placeholder="Analysis result will appear here..." data-i18n-placeholder="analysis_result_placeholder"></textarea>
                </div>
                
                <button class="btn btn-primary" id="usePromptBtn" style="width:100%; margin-top: 5px;"><i class="fas fa-arrow-up"></i> <span data-i18n="use_prompt">Use Prompt</span></button>
            </div>
        </aside>

        <!-- RIGHT SIDEBAR: TECHNICAL SPECS -->
        <aside class="floating-sidebar right" id="sidebar-right">
            <!-- MIXER 3.0 NSFW UI -->
            <div class="mixer-container" id="nsfw-mixer-group" style="display: none;">
                <div class="mixer-header">
                    <div class="mixer-label"><i class="fas fa-tags"></i> <span data-i18n="mixer_3">Mixer 3.0</span></div>
                    <label class="ui-switch">
                        <input type="checkbox" id="nsfw_mixer_toggle" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="mixer-content" id="nsfw-mixer-content">
                    <select id="nsfw-category-select" style="margin-bottom: 5px;">
                        <option value="" data-i18n="select_category">Select Category...</option>
                    </select>
                    <div style="display:flex; gap:5px; height: 150px;">
                        <div id="nsfw-options-list" class="mixer-tag-area" style="flex:1; align-content: flex-start;">
                            <div class="mixer-empty-text" data-i18n="select_category">Select category...</div>
                        </div>
                        <div id="nsfw-selected-list" class="mixer-tag-area" style="flex:1; align-content: flex-start;"></div>
                    </div>
                </div>
            </div>

            <!-- MIXER 4.0 (View Preset) -->
            <div class="mixer-container" id="mix4-mixer-group" style="display: none;">
                <div class="mixer-header">
                    <div class="mixer-label"><i class="fas fa-palette"></i> <span data-i18n="mixer_4">Mixer 4.0 (View)</span></div>
                    <label class="ui-switch">
                        <input type="checkbox" id="mix4_mixer_toggle" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="mixer-content" id="mix4-mixer-content">
                    <select id="mix4-category-select" style="margin-bottom: 5px;">
                        <option value="" data-i18n="select_view">Select View...</option>
                    </select>
                    <div style="display:flex; gap:5px; height: 150px;">
                        <div id="mix4-options-list" class="mixer-tag-area" style="flex:1; align-content: flex-start;">
                            <div class="mixer-empty-text" data-i18n="select_view">Select view...</div>
                        </div>
                        <div id="mix4-selected-list" class="mixer-tag-area" style="flex:1; align-content: flex-start;"></div>
                    </div>
                </div>
            </div>

            <!-- SHARED TECHNICAL PARAMS -->
            <div id="right-t2i-panel" class="content-panel active">
                <div class="control-group">
                    <label data-i18n="quality">Quality</label>
                    <select id="quality">
                        <option value="standard" selected title="Standard Resolution" data-i18n="opt_standard">Standard</option>
                        <option value="2k" title="2K Resolution (approx 2048px)" data-i18n="opt_hd">2K (HD)</option>
                        <option value="4k" title="4K Resolution (approx 3840px)" data-i18n="opt_ultra">4K (Ultra)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label><span data-i18n="guidance">Guidance</span> <span class="value-display" id="guidance-display">3.5</span></label>
                    <input type="range" id="guidance" min="1" max="20" step="0.5" value="3.5">
                </div>

                <div class="control-group">
                    <label data-i18n="seed">Seed (Optional)</label>
                    <div class="input-with-btn">
                        <input type="number" id="seed" placeholder="Random" data-i18n-placeholder="random">
                        <button id="random-seed-btn" data-i18n="random">Random</button>
                    </div>
                </div>

                <div class="control-group">
                    <label for="num_images" data-i18n="number_of_images">Number of Images</label>
                    <input type="number" id="num_images" value="1" min="1" max="10">
                </div>
                
                <div class="control-group">
                    <label><span data-i18n="enhance_prompt">Enhance Prompt</span> <label class="ui-switch">
                        <input type="checkbox" id="enhance_toggle" checked>
                        <span class="slider"></span>
                    </label></label>
                </div>

                <div class="control-group" style="display: none;">
                    <label><span data-i18n="nsfw_mode">NSFW Mode</span> <label class="ui-switch">
                        <input type="checkbox" id="nsfw_toggle" disabled>
                        <span class="slider"></span>
                    </label></label>
                </div>
                
                <div class="control-group" style="display: none;">
                    <label><span data-i18n="nsfw_strength">NSFW Strength</span> <span class="value-display" id="nsfw-strength-display">50</span></label>
                    <input type="range" id="nsfw_strength" min="0" max="100" step="1" value="50" disabled>
                </div>
            </div>

            <!-- I2I SPECIFIC TECHNICAL PARAMS -->
            <div id="right-i2i-panel" class="content-panel">
                <div class="control-group">
                    <label data-i18n="quality">Quality</label>
                    <select id="i2i-quality">
                        <option value="2k" selected data-i18n="opt_hd">2K (HD)</option>
                        <option value="4k" data-i18n="opt_ultra">4K (Ultra)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label data-i18n="seed">Seed</label>
                    <div class="input-with-btn">
                        <input type="number" id="i2i-seed" placeholder="Random" data-i18n-placeholder="random">
                        <button id="i2i-random-seed-btn"><i class="fas fa-dice"></i></button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Preview Area (Center) -->
        <section class="preview-area">
            <div class="placeholder" id="placeholder">
                <img src="https://user.uploads.dev/file/1cd163e8a6e7ed4b3d110ace4f4fd164.webp" alt="Welcome Image">
                <span data-i18n="olike_by_pollination">Olike - by Pollination Best AI</span>
            </div>
            
            <span class="loader" id="loader"></span>
            <div id="loading-status-text"></div>
            
            <div id="results-gallery-container"></div>
            
            <div id="grounding-results" class="grounding-links" style="display:none; position: absolute; bottom: 10px; width: 100%; text-align: center; background: rgba(255,255,255,0.8);">
                <strong>Sources:</strong> <span id="grounding-links-list"></span>
            </div>
        </section>
    </main>

    <!-- Image Preview Modal (UPDATED STRUCTURE) -->
    <div class="modal" id="image-preview-modal">
        <div class="modal-content-wrapper">
            <div class="preview-canvas-container">
                <img id="image-preview-display" alt="Image Preview">
                <button class="close-preview-btn" id="close-image-preview">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal" id="info-modal">
        <div class="modal-content-wrapper" style="max-width: 500px; height: auto; max-height: 80vh; border-radius: 12px; border: 1px solid var(--border-color);">
            <div class="modal-header">
                <div class="logo" style="font-size:1rem;" data-i18n="image_details">Image Details</div>
                <button class="btn" id="close-info-modal" style="padding: 0.4rem 0.8rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="info-modal-content" style="padding: 1.5rem;"></div>
        </div>
    </div>

    <!-- Editor Modal (UPDATED SPLIT LAYOUT) -->
    <div class="modal" id="editor-modal">
        <div class="modal-content-wrapper">
            <div class="modal-body">
                <div class="modal-split-layout">
                    <!-- Left Sidebar: Controls -->
                    <div class="modal-split-sidebar">
                        <button class="modal-back-btn" id="close-editor-modal">
                            <i class="fas fa-chevron-left"></i> <span data-i18n="back">Back</span>
                        </button>
                        <div class="modal-title" data-i18n="editor">Editor</div>

                        <div class="editor-controls">
                            <div class="slider-group">
                                <label data-i18n="brightness">Brightness</label>
                                <input type="range" id="edit-brightness" min="50" max="150" value="100">
                            </div>
                            <div class="slider-group">
                                <label data-i18n="contrast">Contrast</label>
                                <input type="range" id="edit-contrast" min="50" max="150" value="100">
                            </div>
                            <div class="slider-group">
                                <label data-i18n="saturation">Saturation</label>
                                <input type="range" id="edit-saturation" min="0" max="200" value="100">
                            </div>
                        </div>

                        <div class="tool-btns">
                            <button class="btn" id="btn-zoom-in" title="Zoom In">+</button>
                            <button class="btn" id="btn-zoom-out" title="Zoom Out">-</button>
                            <button class="btn" id="btn-rotate-left" title="Rotate Left"></button>
                            <button class="btn" id="btn-rotate-right" title="Rotate Right"></button>
                            <button class="btn" id="btn-flip-h" title="Flip Horizontal"></button>
                            <button class="btn" id="btn-reset" title="Reset" data-i18n="reset">Reset</button>
                        </div>
                        
                        <div style="margin-top:auto; padding-top:1rem; border-top:1px solid var(--border-color);">
                            <button class="btn btn-primary" id="btn-download" style="width:100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span data-i18n="download">Download</span>
                            </button>
                            <button class="btn" id="btn-save-edited-gallery" style="width:100%; margin-top:8px;">
                                <i class="fas fa-save"></i> <span data-i18n="save_to_olike">Save to Olike</span>
                            </button>
                        </div>
                    </div>

                    <!-- Right Canvas: Image -->
                    <div class="modal-split-preview">
                        <img id="editor-image">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Private Gallery Modal (NEW SPLIT LAYOUT) -->
    <div class="modal" id="private-gallery-modal">
        <div class="modal-content-wrapper">
            <div class="modal-body">
                <div class="modal-split-layout">
                    <!-- Left Sidebar -->
                    <div class="modal-split-sidebar">
                        <button class="modal-back-btn" id="close-private-gallery">
                            <i class="fas fa-chevron-left"></i> <span data-i18n="back">Back</span>
                        </button>
                        <div class="modal-title">Olike</div>
                        
                        <div class="control-group">
                            <label data-i18n="sort_by">Sort By</label>
                            <select id="private-gallery-sort-select">
                                <option value="date_desc" data-i18n="opt_newest">Newest First</option>
                                <option value="date_asc" data-i18n="opt_oldest">Oldest First</option>
                                <option value="size_desc" data-i18n="opt_largest">Largest First</option>
                                <option value="size_asc" data-i18n="opt_smallest">Smallest First</option>
                                <option value="nsfw" data-i18n="nsfw_first">NSFW First</option>
                            </select>
                        </div>
                        <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color);">
                            <span id="storage-status" style="font-size: 0.75rem; color: var(--text-muted); font-family: monospace;"></span>
                        </div>
                    </div>
                    
                    <!-- Right Preview/Canvas -->
                    <div class="modal-split-preview">
                        <div id="private-gallery-content">
                            <div class="placeholder" id="private-gallery-placeholder" style="position: static; border: none; box-shadow: none;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5; margin-bottom:10px">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <span data-i18n="no_images_saved">No images saved yet.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Bottom Floating Bar -->
    <div id="bottom-floating-bar">
        <button class="gallery-nav-btn prev" id="scroll-left"><i class="fas fa-chevron-left"></i></button>
        <!-- UPDATED: Generate Button with SVG Sparkles -->
        <button id="floating-generate-btn" title="Generate" data-i18n-title="generate">
            <img src="https://user.uploads.dev/file/f2c1c066214c9cb7fa6934e01a613020.png" alt="Generate" style="width: 100%; height: 100%; object-fit: contain; border-radius: 30%;">
        </button>
        <button class="gallery-nav-btn next" id="scroll-right"><i class="fas fa-chevron-right"></i></button>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script>
        window.input = window.input || {};

        let API_KEY = ''; 
        const MAX_DIMENSION = 4096; 
        const MIN_DIMENSION = 200;

        const POLLEN_COSTS = {
            t2i: { flux: 0.0002, kontext: 0.04, zimage: 0.0002, nanobanana: 0.04, seedream: 0.03, klein: 0.008, 'klein-large': 0.012 },
            i2i: { seedream: 0.03, kontext: 0.04, 'seedream-pro': 0.04, gptimage: 0.06, 'nanobanana-pro': 0.14, klein: 0.008, 'klein-large': 0.012 }
        };
        
        const MODEL_ESTIMATES = {
            'flux': '3-8s',
            'zimage': '4-6s',
            'nanobanana': '3-6s',
            'kontext': '10-20s',
            'seedream': '10-15s',
            'seedream-pro': '15-25s',
            'nanobanana-pro': '25-45s',
            'gptimage': '60s+',
            'klein': '3-6s',
            'klein-large': '5-8s'
        };
        
        let pollenBalance = 10.00; 
        
        // Active Tab State (t2i, i2i, i2p)
        let activeTab = 't2i';

        // Editor State with Optimization
        let cropper = null;
        let currentFilters = { brightness: 100, contrast: 100, saturation: 100 };
        let filterRequest = null; 
        let currentEditorMetadata = {}; // Store metadata for editor

        let currentPreviewZoom = 1;
        let isDraggingPreview = false;
        let previewStartX = 0;
        let previewStartY = 0;
        let previewTranslateX = 0;
        let previewTranslateY = 0;
        
        // GLOBAL STATE TO TRACK ACTIVE REQUESTS
        let activeGenerationCount = 0;

        // ===== TRANSLATIONS =====
        const translations = {
            en: {
                "clock_wita": "WITA",
                "pollen_tooltip": "Tier: Flower (Resets Daily)",
                "reset_timer": "Countdown to Daily Reset (19:20 Local Time)",
                "sidebar_input": "Toggle Input Sidebar",
                "back_home": "Back to Main Generator",
                "sidebar_settings": "Toggle Settings Sidebar",
                "toggle_theme": "Toggle Light/Dark Mode",
                "toggle_lang": "Switch Language",
                "get_api_key": "Get API Key",
                "paste_api_key": "Paste API Key here",
                "tab_t2i": "T2I",
                "tab_i2i": "I2I",
                "tab_i2p": "I2P",
                "ai_assistant": "AI Assistant",
                "describe_what_you_want": "Describe what you want...",
                "gen_prompt": "Generate Prompt",
                "remix_prompt": "Remix Prompt",
                "prompt": "Prompt",
                "describe_imagination": "Describe your imagination...",
                "negative_prompt": "Negative Prompt",
                "what_to_avoid": "What to avoid...",
                "aspect_ratio": "Aspect Ratio",
                "width": "Width",
                "height": "Height",
                "model": "Model",
                "input_images": "Input Images",
                "no_images_added": "No images added",
                "add_url": "Add URL",
                "describe_changes": "Describe changes...",
                "ratio": "Ratio",
                "strength": "Strength",
                "instructions": "Instructions",
                "instructions_placeholder": "E.g., 'Describe the main subject', 'What lighting?'",
                "upload": "Upload",
                "url": "URL",
                "result": "Result",
                "analysis_result_placeholder": "Analysis result will appear here...",
                "use_prompt": "Use Prompt",
                "mixer_3": "Mixer 3.0",
                "mixer_4": "Mixer 4.0 (View)",
                "select_category": "Select Category...",
                "select_view": "Select View...",
                "quality": "Quality",
                "guidance": "Guidance",
                "seed": "Seed (Optional)",
                "random": "Random",
                "number_of_images": "Number of Images",
                "enhance_prompt": "Enhance Prompt",
                "nsfw_mode": "NSFW Mode",
                "nsfw_strength": "NSFW Strength",
                "image_details": "Image Details",
                "editor": "Editor",
                "brightness": "Brightness",
                "contrast": "Contrast",
                "saturation": "Saturation",
                "reset": "Reset",
                "download": "Download",
                "save_to_olike": "Save to Olike",
                "sort_by": "Sort By",
                "storage_used": "Used",
                "back": "Back",
                "no_images_saved": "No images saved yet.",
                "olike_by_pollination": "Olike - by Pollination Best AI",
                "opt_square": "1:1 Square",
                "opt_standard": "4:3 Standard",
                "opt_widescreen": "16:9 Widescreen",
                "opt_portrait": "9:16 Portrait",
                "opt_custom": "Custom",
                "opt_hd": "2K (HD)",
                "opt_ultra": "4K (Ultra)",
                "opt_newest": "Newest First",
                "opt_oldest": "Oldest First",
                "opt_largest": "Largest First",
                "opt_smallest": "Smallest First",
                "nsfw_first": "NSFW First",
                "fast": "Fast",
                "detailed": "Detailed",
                "generate": "Generate"
            },
            id: {
                "clock_wita": "WITA",
                "pollen_tooltip": "Tingkat: Bunga (Reset Harian)",
                "reset_timer": "Hitung Mundur Reset Harian (19:20 Waktu Lokal)",
                "sidebar_input": "Buka/Tutup Sidebar Input",
                "back_home": "Kembali ke Generator Utama",
                "sidebar_settings": "Buka/Tutup Sidebar Pengaturan",
                "toggle_theme": "Ganti Mode Terang/Gelap",
                "toggle_lang": "Ganti Bahasa",
                "get_api_key": "Dapatkan API Key",
                "paste_api_key": "Tempel API Key di sini",
                "tab_t2i": "T2I",
                "tab_i2i": "I2I",
                "tab_i2p": "I2P",
                "ai_assistant": "Asisten AI",
                "describe_what_you_want": "Jelaskan apa yang Anda inginkan...",
                "gen_prompt": "Buat Prompt",
                "remix_prompt": "Remix Prompt",
                "prompt": "Prompt",
                "describe_imagination": "Gambarkan imajinasi Anda...",
                "negative_prompt": "Prompt Negatif",
                "what_to_avoid": "Apa yang harus dihindari...",
                "aspect_ratio": "Rasio Aspek",
                "width": "Lebar",
                "height": "Tinggi",
                "model": "Model",
                "input_images": "Gambar Masukan",
                "no_images_added": "Belum ada gambar",
                "add_url": "Tambah URL",
                "describe_changes": "Jelaskan perubahan...",
                "ratio": "Rasio",
                "strength": "Kekuatan",
                "instructions": "Instruksi",
                "instructions_placeholder": "Contoh: 'Jelaskan subjek utama', 'Pencahayaan apa?'",
                "upload": "Unggah",
                "url": "URL",
                "result": "Hasil",
                "analysis_result_placeholder": "Hasil analisis akan muncul di sini...",
                "use_prompt": "Gunakan Prompt",
                "mixer_3": "Mixer 3.0",
                "mixer_4": "Mixer 4.0 (Tampilan)",
                "select_category": "Pilih Kategori...",
                "select_view": "Pilih Tampilan...",
                "quality": "Kualitas",
                "guidance": "Panduan (Guidance)",
                "seed": "Seed (Opsional)",
                "random": "Acak",
                "number_of_images": "Jumlah Gambar",
                "enhance_prompt": "Tingkatkan Prompt",
                "nsfw_mode": "Mode NSFW",
                "nsfw_strength": "Kekuatan NSFW",
                "image_details": "Detail Gambar",
                "editor": "Editor",
                "brightness": "Kecerahan",
                "contrast": "Kontras",
                "saturation": "Saturasi",
                "reset": "Reset",
                "download": "Unduh",
                "save_to_olike": "Simpan ke Olike",
                "sort_by": "Urutkan",
                "storage_used": "Terpakai",
                "back": "Kembali",
                "no_images_saved": "Belum ada gambar tersimpan.",
                "olike_by_pollination": "Olike - oleh Pollination Best AI",
                "opt_square": "1:1 Kotak",
                "opt_standard": "4:3 Standar",
                "opt_widescreen": "16:9 Layar Lebar",
                "opt_portrait": "9:16 Potret",
                "opt_custom": "Kustom",
                "opt_hd": "2K (HD)",
                "opt_ultra": "4K (Ultra)",
                "opt_newest": "Terbaru",
                "opt_oldest": "Terlama",
                "opt_largest": "Terbesar",
                "opt_smallest": "Terkecil",
                "nsfw_first": "NSFW Dulu",
                "fast": "Cepat",
                "detailed": "Detail",
                "generate": "Buat"
            }
        };

        function setLanguage(lang) {
            localStorage.setItem('imgoLang', lang);
            const t = translations[lang];
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });

            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (t[key]) el.title = t[key];
            });
            
            const btn = document.getElementById('lang-toggle-btn');
            if(btn) btn.textContent = lang.toUpperCase();
        }

        function handleLangToggle() {
            const current = localStorage.getItem('imgoLang') || 'en';
            const next = current === 'en' ? 'id' : 'en';
            setLanguage(next);
        }

        // ===== INDEXEDDB HELPERS =====
        const DB_NAME = 'ImgoGalleryDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'images';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function addToDB(data) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(data);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function getAllFromDB() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function deleteFromDB(id) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        async function updateStorageInfo() {
            const statusEl = document.getElementById('storage-status');
            if (!statusEl) return;
            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                    // Use translation dictionary logic here manually or simple string since it's dynamic
                    const lang = localStorage.getItem('imgoLang') || 'en';
                    const usedLabel = lang === 'id' ? 'Terpakai' : 'Used';
                    
                    let text = `${usedLabel}: ${usedMB} MB`;
                    if (estimate.quota) {
                        const percent = ((estimate.usage / estimate.quota) * 100).toFixed(2);
                        text += ` (${percent}%)`;
                        if (parseFloat(percent) > 80) statusEl.style.color = 'var(--warning)';
                        else statusEl.style.color = 'var(--text-muted)';
                    }
                    statusEl.textContent = text;
                    if (window.innerWidth > 400) statusEl.style.display = 'inline-block';
                } catch (e) { console.error("Storage Estimate Error:", e); }
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function showToast(message, type = 'normal') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = '';
            if (type === 'error') icon = '<i class="fas fa-exclamation-circle"></i>';
            else if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
            else if (type === 'warning') icon = '<i class="fas fa-exclamation-triangle"></i>';

            toast.innerHTML = `${icon}<span>${message}</span>`;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatBytes(bytes, decimals = 2) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Helper to convert Blob to PNG (Higher File Size)
        function convertBlobToPng(blob) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(blob);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob((pngBlob) => {
                        URL.revokeObjectURL(url);
                        if (pngBlob) resolve(pngBlob);
                        else reject(new Error("Canvas conversion failed"));
                    }, 'image/png');
                };
                img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    reject(e);
                };
                img.src = url;
            });
        }

        function adjustDimensions(w, h) {
            let width = parseInt(w);
            let height = parseInt(h);
            if (width < MIN_DIMENSION) width = MIN_DIMENSION;
            if (height < MIN_DIMENSION) height = MIN_DIMENSION;
            const aspectRatio = width / height;
            if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
                if (width > height) { width = MAX_DIMENSION; height = Math.round(MAX_DIMENSION / aspectRatio); } 
                else { height = MAX_DIMENSION; width = Math.round(MAX_DIMENSION * aspectRatio); }
            }
            width = Math.floor(width / 16) * 16;
            height = Math.floor(height / 16) * 16;
            return { width, height };
        }
        
        function calculateFinalDimensions(ratio, quality, model) {
            let width = 1024;
            let height = 1024;
            if (model === 'flux' && quality === 'standard') {
                if (ratio === '16:9') { width = 1280; height = 720; }
                else if (ratio === '9:16') { width = 720; height = 1280; }
                else if (ratio === '4:3') { width = 1024; height = 768; } 
                else { width = 1024; height = 1024; }
            } else {
                switch (ratio) {
                    case '1:1': width = 1024; height = 1024; break;
                    case '4:3': width = 1024; height = 768; break;
                    case '16:9': width = 1024; height = 576; break;
                    case '9:16': width = 576; height = 1024; break;
                    default: width = 1024; height = 1024; break;
                }
            }
            if (quality === '2k') { const scale = 2048 / Math.max(width, height); width = Math.round(width * scale); height = Math.round(height * scale); } 
            else if (quality === '4k') { const scale = 3840 / Math.max(width, height); width = Math.round(width * scale); height = Math.round(height * scale); }
            width = Math.floor(width / 16) * 16;
            height = Math.floor(height / 16) * 16;
            return { width, height };
        }

        function applyFilters() {
            if (filterRequest) return;
            filterRequest = requestAnimationFrame(() => {
                const filterString = `brightness(${currentFilters.brightness}%) contrast(${currentFilters.contrast}%) saturate(${currentFilters.saturation}%)`;
                const viewImage = document.querySelector('.cropper-view-box img');
                if (viewImage) viewImage.style.filter = filterString;
                const canvasImage = document.querySelector('.cropper-canvas img');
                if (canvasImage) canvasImage.style.filter = filterString;
                filterRequest = null;
            });
        }
        
        function updateApiStatus() {
            if (!inputs.pollinationsApiKeyInput) return; 
            API_KEY = inputs.pollinationsApiKeyInput.value.trim();
            
            // Icon in sidebar label
            const icon = document.getElementById('api-key-status-icon');
            
            if (API_KEY) {
                if(icon) icon.classList.add('active');
                fetchPollenBalance();
            } else {
                if(icon) icon.classList.remove('active');
                updatePollenDisplay(); // Update display immediately when key is removed
            }
        }
        
        async function fetchPollenBalance() {
            if (!API_KEY) return;
            const display = document.getElementById('pollen-count-display');
            const refreshBtn = document.getElementById('refresh-balance-btn');
            if(refreshBtn) refreshBtn.style.transform = 'rotate(180deg)'; 
            try {
                // Changed endpoint to gen.pollinations.ai/account/balance
                const response = await fetch(`https://gen.pollinations.ai/account/balance?_=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.balance !== undefined) {
                        const newBalance = parseFloat(data.balance);
                        // User request: Only show toast if balance DECREASED
                        if (newBalance < pollenBalance) {
                            showToast('Balance synced: ' + newBalance.toFixed(2), 'success');
                        }
                        
                        pollenBalance = newBalance;
                        updatePollenDisplay();
                        const currentConfig = JSON.parse(localStorage.getItem('imgoConfig') || '{}');
                        currentConfig.pollenBalance = pollenBalance;
                        localStorage.setItem('imgoConfig', JSON.stringify(currentConfig));
                    }
                }
            } catch (error) { console.warn("Failed to sync pollen balance:", error); } 
            finally { if(refreshBtn) setTimeout(() => refreshBtn.style.transform = 'none', 500); }
        }
        
        function updatePollenDisplay() {
            const display = document.getElementById('pollen-count-display');
            const container = document.getElementById('pollen-status-display');
            if (display) {
                if (!API_KEY) {
                    display.textContent = "--"; // Tampilkan kosong/strip jika tidak ada key
                    if(container) container.style.opacity = '0.5'; // Visual cue inactive
                    if(container) container.title = "Please enter API Key to see balance";
                } else {
                    display.textContent = (pollenBalance !== null ? pollenBalance : 0).toFixed(2);
                    if(container) container.style.opacity = '1';
                    if(container) container.title = "Tier: Flower (Resets Daily)";
                }
            }
        }
        
        function updatePreviewTransform() {
            if (imagePreviewDisplay) imagePreviewDisplay.style.transform = `translate(${previewTranslateX}px, ${previewTranslateY}px) scale(${currentPreviewZoom})`;
        }

        function checkDailyReset() {
            const now = new Date();
            let todayResetTime = new Date(now);
            todayResetTime.setHours(19, 20, 0, 0);
            let lastOfficialResetPoint = new Date(todayResetTime);
            if (now < todayResetTime) lastOfficialResetPoint.setDate(lastOfficialResetPoint.getDate() - 1);
            const lastLocalResetStored = localStorage.getItem('imgoLastResetTimestamp');
            if (!lastLocalResetStored || new Date(parseInt(lastLocalResetStored)) < lastOfficialResetPoint) {
                pollenBalance = 10.00;
                updatePollenDisplay();
                localStorage.setItem('imgoLastResetTimestamp', now.getTime());
                const currentConfig = JSON.parse(localStorage.getItem('imgoConfig') || '{}');
                currentConfig.pollenBalance = 10.00;
                localStorage.setItem('imgoConfig', JSON.stringify(currentConfig));
                showToast('Daily Reset (19:20): Pollen restored to 10.00!', 'success');
            }
        }

        function updateCountdownTimer() {
            const now = new Date();
            let nextReset = new Date(now);
            nextReset.setHours(19, 20, 0, 0);
            if (now >= nextReset) nextReset.setDate(nextReset.getDate() + 1);
            const diff = nextReset - now;
            const display = document.getElementById('reset-timer-display');
            if (display) {
                if (diff < 0) { display.textContent = " Calculating..."; return; }
                const h = Math.floor(diff / (1000 * 60 * 60)).toString().padStart(2, '0');
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                const s = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');
                display.textContent = ` ${h}h ${m}m ${s}s`;
            }
            if (diff <= 1000) setTimeout(checkDailyReset, 2000); 
        }
        
        function updateRealtimeClock() {
            const clockEl = document.getElementById('header-clock');
            if (clockEl) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Makassar', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                clockEl.textContent = `${timeString} WITA`;
            }
        }

        function saveConfig() {
            if (!inputs.prompt) return;
            const i2iPrimary = i2iInputImages.length > 0 ? i2iInputImages[0] : null;
            
            // Save Mixer State
            const selectedNsfwTags = [];
            if(nsfwSelectedList && nsfwSelectedList.querySelectorAll) {
                nsfwSelectedList.querySelectorAll('.mixer-tag').forEach(el => selectedNsfwTags.push({name: el.innerText, value: el.dataset.value}));
            }
            
            // Save Mixer 4 State
            const selectedMix4Tags = [];
            if(mix4SelectedList && mix4SelectedList.querySelectorAll) {
                mix4SelectedList.querySelectorAll('.mixer-tag').forEach(el => selectedMix4Tags.push({name: el.innerText, value: el.dataset.value}));
            }

            const config = {
                prompt: inputs.prompt?.value, negPrompt: inputs.negPrompt?.value, aspectRatio: inputs.aspectRatio?.value,
                width: inputs.width?.value, height: inputs.height?.value, imageModel: inputs.imageModelSelect?.value,
                quality: inputs.quality?.value, guidance: inputs.guidance?.value, seed: inputs.seed?.value,
                numImages: inputs.numImages?.value, nsfwMode: inputs.nsfwToggle?.checked, nsfwStrength: inputs.nsfwStrength?.value,
                enhanceMode: inputs.enhanceToggle?.checked,
                pollinationsApiKey: inputs.pollinationsApiKeyInput?.value.trim(),
                i2iImageBase64: i2iPrimary, i2iPrompt: inputs.i2iPromptInput?.value, i2iNegPrompt: inputs.i2iNegPromptInput?.value,
                i2iModel: inputs.i2iModelSelect?.value, i2iQuality: inputs.i2iQuality?.value, pollenBalance: pollenBalance,
                activeTab: activeTab,
                // Mixer Config
                nsfwMixerActive: inputs.nsfwMixerToggle ? inputs.nsfwMixerToggle.checked : false,
                nsfwMixerTags: selectedNsfwTags,
                // Mixer 4 Config
                mix4MixerActive: inputs.mix4MixerToggle ? inputs.mix4MixerToggle.checked : false,
                mix4MixerTags: selectedMix4Tags
            };
            localStorage.setItem('imgoConfig', JSON.stringify(config));
            updateApiStatus();
        }

        // Global placeholders
        let floatingGenerateBtn, resultsGalleryContainer, loader, placeholder, toastContainer, headerPrivateGalleryBtn, headerLogoBtn, groundingResults, groundingLinksList;
        let pollinationsApiKeyInput;
        let imagePreviewModal, imagePreviewDisplay, closeImagePreviewBtn; 
        let editorModal, editorImage, closeEditorModalBtn; 
        let privateGalleryModal, privateGalleryContent, closePrivateGalleryBtn, privateGalleryPlaceholder, privateGallerySortSelect;
        let infoModal, closeInfoModalBtn, infoModalContent;
        let scrollLeftBtn, scrollRightBtn;
        let themeToggleBtn; 
        let langToggleBtn; // Added Language Toggle
        let refreshBalanceBtn; 
        let loadingStatusText;
        
        // I2P Elements in Sidebar
        let i2pModelFastBtn, i2pModelDetailedBtn, imageToTextInput, i2pUploadBtn, i2pUrlBtn, imageUploadEl, imagePreviewContainer, uploadedImageDisplay, imageToText, usePromptBtn;
        let currentI2PImageBase64 = null;
        let currentI2PModel = 'fast'; 
        let isProcessingI2P = false;
        let abortControllerI2P = null;

        // Sidebar Tabs
        let tabT2IBtn, tabI2IBtn, tabI2PBtn, t2iControls, i2iControls, i2pControls;

        // I2I Elements in Sidebar
        let i2iUrlBtn, i2iPromptInput, i2iNegPromptInput, i2iModelSelect, clearI2IInputBtn;
        let i2iInputGallery, i2iEmptyPlaceholder;
        let i2iAspectRatio, i2iQuality, i2iGuidance, i2iSeed, i2iRandomSeedBtn, i2iGuidanceVal;
        let i2iInputImages = []; 
        
        let isProcessingI2I = false;
        let abortControllerI2I = null;
        
        // Mixer Elements
        let nsfwMixerToggle, nsfwCategorySelect, nsfwOptionsList, nsfwSelectedList, nsfwMixerGroup, nsfwMixerContent;
        
        // Mixer 4.0 Elements
        let mix4MixerToggle, mix4CategorySelect, mix4OptionsList, mix4SelectedList, mix4MixerGroup, mix4MixerContent;
        
        // AI Assistant Elements
        let aiGenerateBtn, aiRemixBtn, aiAssistantInput;
        
        // Sidebar Toggles
        let toggleLeftSidebarBtn, toggleRightSidebarBtn, sidebarLeft, sidebarRight;

        let inputs = {};
        let displays = {};

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // TAB SWITCHING LOGIC
        function switchTab(tabName) {
            activeTab = tabName;
            
            // Toggle Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}-btn`).classList.add('active');
            
            // Toggle Content in LEFT Sidebar
            document.getElementById('left-t2i-panel').classList.toggle('active', tabName === 't2i');
            document.getElementById('left-i2i-panel').classList.toggle('active', tabName === 'i2i');
            document.getElementById('left-i2p-panel').classList.toggle('active', tabName === 'i2p');
            
            // Toggle Content in RIGHT Sidebar
            document.getElementById('right-t2i-panel').classList.toggle('active', tabName === 't2i');
            document.getElementById('right-i2i-panel').classList.toggle('active', tabName === 'i2i');
            // I2P might not have right panel, if so hide everything or show empty
            
            saveConfig();
        }

        function loadConfig() {
            try {
                // Initialize Theme
                const savedTheme = localStorage.getItem('imgoTheme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (prefersDark ? 'dark' : 'light');
                setTheme(theme);
                
                // Initialize Language
                const savedLang = localStorage.getItem('imgoLang') || 'en';
                setLanguage(savedLang);

                const savedConfig = JSON.parse(localStorage.getItem('imgoConfig'));
                if (savedConfig) {
                    if(inputs.prompt) inputs.prompt.value = savedConfig.prompt || '';
                    if(inputs.negPrompt) inputs.negPrompt.value = savedConfig.negPrompt || '';
                    if(inputs.aspectRatio) inputs.aspectRatio.value = savedConfig.aspectRatio || '9:16';
                    if(inputs.imageModelSelect) inputs.imageModelSelect.value = savedConfig.imageModel || 'zimage';
                    if(inputs.quality) inputs.quality.value = savedConfig.quality || 'standard';
                    if(inputs.guidance) inputs.guidance.value = savedConfig.guidance || '3.5';
                    if(inputs.seed) inputs.seed.value = savedConfig.seed || '';
                    if(inputs.numImages) inputs.numImages.value = savedConfig.numImages || '1'; 
                    // DISABLE NSFW / MIXERS by default for community
                    if(inputs.nsfwToggle) inputs.nsfwToggle.checked = false; // savedConfig.nsfwMode || false;
                    if(inputs.nsfwStrength) inputs.nsfwStrength.value = savedConfig.nsfwStrength || '50';
                    if(inputs.enhanceToggle) inputs.enhanceToggle.checked = savedConfig.enhanceMode !== undefined ? savedConfig.enhanceMode : true;
                    if(inputs.pollinationsApiKeyInput) inputs.pollinationsApiKeyInput.value = savedConfig.pollinationsApiKey || '';
                    pollenBalance = savedConfig.pollenBalance !== undefined ? parseFloat(savedConfig.pollenBalance) : 10.00;
                    
                    // Load primary I2I image
                    if (savedConfig.i2iImageBase64) {
                        i2iInputImages = [savedConfig.i2iImageBase64];
                        updateI2IGalleryUI();
                    }
                    if(inputs.i2iPromptInput) inputs.i2iPromptInput.value = savedConfig.i2iPrompt || '';
                    if(inputs.i2iNegPromptInput) inputs.i2iNegPromptInput.value = savedConfig.i2iNegPrompt || '';
                    if(inputs.i2iModelSelect) inputs.i2iModelSelect.value = savedConfig.i2iModel || 'seedream';
                    const savedQuality = savedConfig.i2iQuality || '2k';
                    if(inputs.i2iQuality) inputs.i2iQuality.value = (savedQuality === 'standard') ? '2k' : savedQuality;
                    
                    // Restore active tab
                    if (savedConfig.activeTab) {
                        switchTab(savedConfig.activeTab);
                    }
                    
                    // Restore Mixer (DISABLED FOR COMMUNITY)
                    if (inputs.nsfwMixerToggle) {
                        inputs.nsfwMixerToggle.checked = false; // savedConfig.nsfwMixerActive || false;
                        toggleMixerDisplay(false);
                    }
                    
                    // Restore Mixer 4.0 (DISABLED FOR COMMUNITY)
                    if (inputs.mix4MixerToggle) {
                        inputs.mix4MixerToggle.checked = false; // savedConfig.mix4MixerActive === true; 
                        toggleMixer4Display(false);
                    }
                }
                
                handleAspectRatioChange();
                handleNsfwToggleChange();
                updateApiStatus();
                updatePollenDisplay();
                checkDailyReset();

                if(displays.width) displays.width.textContent = inputs.width?.value;
                if(displays.height) displays.height.textContent = inputs.height?.value;
                if(displays.guidance) displays.guidance.textContent = inputs.guidance?.value;
                if(displays.nsfwStrength) displays.nsfwStrength.textContent = inputs.nsfwStrength?.value;

                if(inputs.prompt) window.input.prompt = inputs.prompt.value;
                if(inputs.negPrompt) window.input.negative_prompt = inputs.negPrompt.value;
            } catch (e) {
                console.error("Error loading config:", e);
            }
        }

        // Theme Functionality
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('imgoTheme', theme);
            const icon = themeToggleBtn.querySelector('i');
            if (theme === 'light') { icon.className = 'fas fa-moon'; themeToggleBtn.title = "Switch to Dark Mode"; } 
            else { icon.className = 'fas fa-sun'; themeToggleBtn.title = "Switch to Light Mode"; }
        }

        function handleThemeToggle() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }

        function attachInputListeners() {
            inputs.prompt?.addEventListener('input', saveConfig); 
            inputs.negPrompt?.addEventListener('input', saveConfig);
            inputs.pollinationsApiKeyInput?.addEventListener('input', saveConfig); 
            inputs.width?.addEventListener('input', (e) => { if(displays.width) displays.width.textContent = e.target.value; saveConfig(); });
            inputs.height?.addEventListener('input', (e) => { if(displays.height) displays.height.textContent = e.target.value; saveConfig(); });
            inputs.imageModelSelect?.addEventListener('change', saveConfig); 
            inputs.quality?.addEventListener('change', () => { handleAspectRatioChange(); saveConfig(); });
            inputs.guidance?.addEventListener('input', (e) => { if(displays.guidance) displays.guidance.textContent = e.target.value; saveConfig(); });
            inputs.seed?.addEventListener('input', saveConfig);
            inputs.numImages?.addEventListener('input', saveConfig); 
            inputs.randomSeedBtn?.addEventListener('click', () => {
                const randomSeed = Math.floor(Math.random() * 999999999);
                if(inputs.seed) inputs.seed.value = randomSeed;
                saveConfig(); showToast('Seed randomized!', 'normal');
            });
            inputs.aspectRatio?.addEventListener('change', handleAspectRatioChange);
            inputs.nsfwToggle?.addEventListener('change', handleNsfwToggleChange);
            inputs.nsfwStrength?.addEventListener('input', (e) => { if(displays.nsfwStrength) displays.nsfwStrength.textContent = e.target.value; saveConfig(); });
            inputs.enhanceToggle?.addEventListener('change', saveConfig);

            inputs.i2iPromptInput?.addEventListener('input', saveConfig);
            inputs.i2iNegPromptInput?.addEventListener('input', saveConfig);
            inputs.i2iModelSelect?.addEventListener('change', saveConfig); 
            inputs.i2iQuality?.addEventListener('change', saveConfig);
            
            // Mixer Listener
            inputs.nsfwMixerToggle?.addEventListener('change', (e) => {
                toggleMixerDisplay(e.target.checked);
                saveConfig();
            });
            // Mixer 4 Listener
            inputs.mix4MixerToggle?.addEventListener('change', (e) => {
                toggleMixer4Display(e.target.checked);
                saveConfig();
            });
        }

        function handleAspectRatioChange() {
            if(!inputs.aspectRatio) return;
            const selectedRatio = inputs.aspectRatio.value;
            const selectedQuality = inputs.quality.value;
            const selectedModel = inputs.imageModelSelect.value;

            if(inputs.width) inputs.width.disabled = true;
            if(inputs.height) inputs.height.disabled = true;

            let newWidth, newHeight;
            if (selectedRatio === 'custom') {
                if(inputs.width) inputs.width.disabled = false;
                if(inputs.height) inputs.height.disabled = false;
                newWidth = inputs.width?.value || 1024;
                newHeight = inputs.height?.value || 1024;
            } else {
                const dims = calculateFinalDimensions(selectedRatio, selectedQuality, selectedModel);
                newWidth = dims.width;
                newHeight = dims.height;
                if(inputs.width) inputs.width.value = newWidth;
                if(inputs.height) inputs.height.value = newHeight;
                if(displays.width) displays.width.textContent = newWidth;
                if(displays.height) displays.height.textContent = newHeight;
            }
            saveConfig(); 
        }

        function handleNsfwToggleChange() {
            if(!inputs.nsfwToggle) return;
            const isNsfwEnabled = inputs.nsfwToggle.checked;
            if(inputs.nsfwStrength) inputs.nsfwStrength.disabled = !isNsfwEnabled;
            
            saveConfig();
            if (isNsfwEnabled) showToast('NSFW mode enabled.', 'warning');
            else showToast('NSFW mode disabled.', 'normal');
        }
        
        async function handleGenerateButtonClick() {
            if (activeTab === 't2i') {
                handleT2IGenerate();
            } else if (activeTab === 'i2i') {
                handleI2IGenerate();
            } else if (activeTab === 'i2p') {
                analyzeImageWithAI();
            }
        }

        // T2I GENERATION LOGIC
        async function handleT2IGenerate() {
            // --- SAFETY CHECK (PENCEGAHAN ERROR NULL) ---
            if (!inputs.prompt) {
                console.error("Critical Error: Elemen input 'prompt' tidak ditemukan.");
                showToast("Error: Input prompt hilang. Refresh halaman.", "error");
                return;
            }
            if (!inputs.numImages) {
                console.error("Critical Error: Elemen input 'numImages' tidak ditemukan.");
                showToast("Error: Input jumlah gambar hilang.", "error");
                return;
            }
            if (!inputs.imageModelSelect) {
                console.error("Critical Error: Elemen select 'imageModelSelect' tidak ditemukan.");
                return;
            }
            // ---------------------------------------------

            let prompt = inputs.prompt.value.trim();
            
            // APPEND MIXER 3.0 TAGS
            if (inputs.nsfwMixerToggle && inputs.nsfwMixerToggle.checked && nsfwSelectedList) {
                const tags = Array.from(nsfwSelectedList.querySelectorAll('.mixer-tag'))
                                  .map(el => el.dataset.value);
                if (tags.length > 0) {
                    prompt += ", " + tags.join(", ");
                }
            }
            
            // APPEND MIXER 4.0 TAGS
            if (inputs.mix4MixerToggle && inputs.mix4MixerToggle.checked && mix4SelectedList) {
                const tags4 = Array.from(mix4SelectedList.querySelectorAll('.mixer-tag'))
                                  .map(el => el.dataset.value);
                if (tags4.length > 0) {
                    prompt += ", " + tags4.join(", ");
                }
            }
            
            if (!prompt) { showToast('Please enter a prompt', 'error'); return; }
            // API Check optional agar tidak crash jika kosong
            // if (!API_KEY) { showToast('API Key is missing.', 'error'); return; }

            // Gunakan nilai default jika value kosong/error
            const numImagesVal = inputs.numImages.value;
            const numImages = numImagesVal ? parseInt(numImagesVal) : 1;
            
            const selectedModel = inputs.imageModelSelect.value || 'zimage';
            const costPerImage = POLLEN_COSTS.t2i[selectedModel] || 0.04; 
            
            if (pollenBalance < costPerImage) { showToast(`Insufficient Pollen. Need ${costPerImage} per image.`, 'error'); return; }

            // DISABLE LOGIC REMOVED FOR MULTI-REQUEST
            // floatingGenerateBtn.disabled = true;
            activeGenerationCount++;
            loader.style.display = 'block';
            
            const estTime = MODEL_ESTIMATES[selectedModel] || '5-10s';
            if (loadingStatusText) {
                loadingStatusText.textContent = `T2I Generating... Est. ${estTime}`;
                loadingStatusText.style.display = 'block';
            }

            // ONLY CLEAR IF STARTING FROM EMPTY (Optional: Comment this out to stack images from multiple clicks)
            // resultsGalleryContainer.innerHTML = ''; 
            // placeholder.style.display = 'none'; // REMOVED TO KEEP LOGO VISIBLE
            groundingResults.style.display = 'none'; 
            
            let width, height;
            
            // Safety check untuk aspect ratio
            const ratioVal = inputs.aspectRatio ? inputs.aspectRatio.value : '1:1';
            const qualityVal = inputs.quality ? inputs.quality.value : 'standard';

            if (ratioVal === 'custom') {
                width = inputs.width ? parseInt(inputs.width.value) : 1024;
                height = inputs.height ? parseInt(inputs.height.value) : 1024;
            } else {
                const dims = calculateFinalDimensions(ratioVal, qualityVal, selectedModel);
                width = dims.width;
                height = dims.height;
                
                // Update UI display aman
                if(inputs.width) inputs.width.value = width; 
                if(displays.width) displays.width.textContent = width;
                if(inputs.height) inputs.height.value = height; 
                if(displays.height) displays.height.textContent = height;
            }
            saveConfig();

            for (let i = 0; i < numImages; i++) {
                if (pollenBalance < costPerImage) { break; }
                
                const seedVal = inputs.seed && inputs.seed.value ? inputs.seed.value : "";
                const seed = seedVal ? parseInt(seedVal) + i : Math.floor(Math.random() * 1000000000);
                
                let imgUrl = '';
                let generationError = null;
                
                // Ambil nilai input lain dengan aman
                const negPromptVal = inputs.negPrompt ? inputs.negPrompt.value.trim() : "";
                const guidanceVal = inputs.guidance ? inputs.guidance.value : 3.5;
                const nsfwMode = inputs.nsfwToggle ? inputs.nsfwToggle.checked : false;
                const nsfwStrengthVal = inputs.nsfwStrength ? inputs.nsfwStrength.value : 50;
                const enhanceMode = inputs.enhanceToggle ? inputs.enhanceToggle.checked : false;

                let genOutputMetadata = {
                    prompt, negativePrompt: negPromptVal, aspectRatio: ratioVal,
                    width, height, model: selectedModel, quality: qualityVal,
                    guidance: guidanceVal, seed, nsfwMode: nsfwMode,
                    nsfwStrength: nsfwStrengthVal, provider: 'Pollinations.ai', 
                    tags: nsfwMode ? ['nsfw', 't2i'] : ['t2i'],
                };

                try {
                    const params = new URLSearchParams({
                        width, height, model: selectedModel, seed,
                        nologo: 'true', private: 'true', nofeed: 'true', 
                        enhance: enhanceMode,
                        guidance_scale: guidanceVal, key: API_KEY
                    });
                    if (qualityVal === '2k' || qualityVal === '4k') params.append('quality', 'hd');
                    if (nsfwMode) { params.append('nsfw', 'true'); params.append('nsfw_strength', nsfwStrengthVal); } else { params.append('safe', 'true'); }
                    if (negPromptVal) params.append('negative_prompt', negPromptVal);

                    const url = `https://gen.pollinations.ai/image/${encodeURIComponent(prompt)}?${params.toString()}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    let blob = await response.blob();
                    
                    try {
                        const pngBlob = await convertBlobToPng(blob);
                        if(pngBlob) blob = pngBlob;
                    } catch(e) { 
                        console.warn("PNG conversion failed, keeping original format", e); 
                    }

                    const fileSizeStr = formatBytes(blob.size);
                    genOutputMetadata.fileSize = fileSizeStr;
                    imgUrl = URL.createObjectURL(blob);
                    genOutputMetadata.imageUrl = imgUrl;
                } catch (error) { generationError = error; showToast(`Generation ${i + 1} failed.`, 'error'); }

                if (!generationError) {
                    // Removed local pollen deduction
                    updatePollenDisplay();
                    saveConfig();
                    addImageToGallery(imgUrl, width, height, genOutputMetadata);
                    // Hide placeholder ONLY after success
                    if(placeholder) placeholder.style.display = 'none'; 
                    showToast(`Image ${i + 1} generated!`, 'success');
                    fetchPollenBalance(); // Immediate sync
                }
            }
            
            // DECREMENT ACTIVE COUNT
            activeGenerationCount--;
            if(activeGenerationCount <= 0) {
                loader.style.display = 'none';
                if (loadingStatusText) loadingStatusText.style.display = 'none';
                activeGenerationCount = 0;
            }
            
            // REMOVE PLACEHOLDER LOGIC
            // if (resultsGalleryContainer.children.length === 0 && activeGenerationCount === 0) placeholder.style.display = 'flex'; 
            // else placeholder.style.display = 'none';
            // floatingGenerateBtn.disabled = false; // DISABLED LOGIC REMOVED
        }

        // I2I GENERATION LOGIC (Sidebar)
        async function handleI2IGenerate() {
            if (i2iInputImages.length === 0) { showToast('No input images for I2I.', 'error'); return; }
            
            const prompt = inputs.i2iPromptInput.value.trim();
            if (!prompt) { showToast('Enter I2I prompt.', 'error'); return; }
            // Removed blocking check: if (isProcessingI2I) return;
            // API Key check optional
            // if (!API_KEY) { showToast('API Key missing.', 'error'); return; }

            const selectedModel = inputs.i2iModelSelect.value;
            const cost = POLLEN_COSTS.i2i[selectedModel] || 0.06;
            
            if (pollenBalance < cost) { showToast(`Insufficient Pollen. Need ${cost}.`, 'error'); return; }

            // isProcessingI2I = true; // REMOVED
            // floatingGenerateBtn.disabled = true; // REMOVED
            
            activeGenerationCount++;
            loader.style.display = 'block';
            
            const estTime = MODEL_ESTIMATES[selectedModel] || '15-20s';
            if (loadingStatusText) {
                loadingStatusText.textContent = `I2I Generating... Est. ${estTime}`;
                loadingStatusText.style.display = 'block';
            }
            
            // placeholder.style.display = 'none'; // REMOVE THIS
            groundingResults.style.display = 'none';
            
            saveConfig();
            abortControllerI2I = new AbortController();

            try {
                // Determine dimensions
                const ratio = i2iAspectRatio ? i2iAspectRatio.value : '9:16';
                const quality = i2iQuality ? i2iQuality.value : 'standard'; 
                const dims = calculateFinalDimensions(ratio, quality, selectedModel);
                const finalWidth = dims.width;
                const finalHeight = dims.height;

                const baseImage = i2iInputImages[0];
                let finalPrompt = prompt;
                if (i2iInputImages.length > 1) {
                     const extraImages = i2iInputImages.slice(1);
                     const validUrls = extraImages.filter(url => url.startsWith('http'));
                     if (validUrls.length > 0) finalPrompt += " --reference_image " + validUrls.join(" ");
                }
                
                const seedVal = (i2iSeed && i2iSeed.value) ? parseInt(i2iSeed.value) : Math.floor(Math.random() * 1000000000);
                const guidanceVal = (i2iGuidance) ? i2iGuidance.value : 3.5;
                const negPrompt = i2iNegPromptInput ? i2iNegPromptInput.value.trim() : '';
                
                const params = new URLSearchParams({
                    image: baseImage, model: selectedModel, 
                    width: finalWidth, height: finalHeight, seed: seedVal,
                    guidance_scale: guidanceVal, nologo: 'true', private: 'true', enhance: 'true', key: API_KEY
                });
                
                if (quality === '2k' || quality === '4k') { params.append('quality', 'hd'); } 
                else { params.append('quality', inputs.quality.value); }
                
                if (inputs.nsfwToggle.checked) { params.append('nsfw', 'true'); params.append('nsfw_strength', inputs.nsfwStrength.value); } else { params.append('safe', 'true'); }
                if (negPrompt) params.append('negative_prompt', negPrompt);
                
                const url = `https://gen.pollinations.ai/image/${encodeURIComponent(finalPrompt)}?${params.toString()}`;
                const response = await fetch(url, { method: "GET", signal: abortControllerI2I.signal });
                if (!response.ok) throw new Error('Generation failed');
                
                let blob = await response.blob();
                
                // Auto-Convert to PNG for larger file size (MB)
                try {
                    const pngBlob = await convertBlobToPng(blob);
                    if(pngBlob) blob = pngBlob;
                } catch(e) { 
                    console.warn("PNG conversion failed, keeping original format", e); 
                }

                const fileSizeStr = formatBytes(blob.size);
                
                const imgUrl = URL.createObjectURL(blob);
                
                const genOutputMetadata = {
                    prompt: finalPrompt, negativePrompt: negPrompt, aspectRatio: ratio, 
                    width: finalWidth, height: finalHeight, model: selectedModel, 
                    quality: quality, nsfwMode: inputs.nsfwToggle.checked,
                    nsfwStrength: inputs.nsfwStrength.value, provider: 'Pollinations.ai',
                    tags: inputs.nsfwToggle.checked ? ['nsfw', 'i2i'] : ['i2i'], 
                    imageUrl: imgUrl, fileSize: fileSizeStr
                };

                addImageToGallery(imgUrl, finalWidth, finalHeight, genOutputMetadata);
                
                // Hide placeholder ONLY after success
                if(placeholder) placeholder.style.display = 'none';

                // pollenBalance -= cost; // Removed local deduction
                updatePollenDisplay(); 
                saveConfig();
                
                fetchPollenBalance(); // Immediate sync
                showToast(`I2I Complete!`, 'success');
            } catch (error) {
                if (error.name !== 'AbortError') { showToast(`I2I failed.`, 'error'); }
            } finally { 
                // isProcessingI2I = false; 
                // floatingGenerateBtn.disabled = false; 
                
                activeGenerationCount--;
                if(activeGenerationCount <= 0) {
                    loader.style.display = 'none'; 
                    if (loadingStatusText) loadingStatusText.style.display = 'none';
                    activeGenerationCount = 0;
                }
                abortControllerI2I = null; 
            }
        }

        // Shared function to add image to main gallery
        function addImageToGallery(imgUrl, width, height, metadata) {
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'image-wrapper';
            imageWrapper.dataset.imageUrl = imgUrl;
            const imgAspectRatio = width / height;
            if (imgAspectRatio > 1.2) imageWrapper.dataset.orientation = 'landscape';
            else if (imgAspectRatio < 0.8) imageWrapper.dataset.orientation = 'portrait';
            else imageWrapper.dataset.orientation = 'square';

            const imgElement = document.createElement('img');
            imgElement.src = imgUrl;
            imgElement.alt = metadata.prompt;
            imageWrapper.appendChild(imgElement);
            imageWrapper.dataset.genOutput = JSON.stringify(metadata);

            imageWrapper.addEventListener('click', (e) => openImagePreviewModal(e.currentTarget.dataset.imageUrl));
            
            // Add onload listener to remove black lines (show border)
            imgElement.onload = () => {
                imageWrapper.classList.add('loaded');
            };
            // In case image is cached
            if (imgElement.complete) {
                imageWrapper.classList.add('loaded');
            }

            const hintText = document.createElement('div');
            hintText.className = 'hint-text';
            hintText.textContent = 'Preview'; 
            imageWrapper.appendChild(hintText);

            const actionsBar = document.createElement('div');
            actionsBar.className = 'image-actions-bar';
            actionsBar.innerHTML = `
                <button class='gallery-action-btn' title="Image Info"><i class="fas fa-info-circle"></i></button>
                <button class='gallery-action-btn' title="Download Image"><i class="fas fa-download"></i></button>
                <button class='gallery-action-btn' title="Save to Private Gallery" data-image-url="${imgUrl}"><i class="fas fa-save"></i></button>
                <button class='gallery-action-btn' title="Edit Image" data-image-url="${imgUrl}"><i class="fas fa-pencil-alt"></i></button>
                <button class='gallery-action-btn' title="Delete Image"><i class="fas fa-trash"></i></button>
            `;
            imageWrapper.appendChild(actionsBar);
            
            actionsBar.querySelector('[title="Image Info"]').addEventListener('click', (e) => { e.stopPropagation(); openInfoModal(metadata); });
            actionsBar.querySelector('[title="Download Image"]').addEventListener('click', (e) => {
                e.stopPropagation();
                const a = document.createElement('a');
                a.href = imgUrl;
                a.download = `polli-gen-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast('Downloading image...', 'success');
            });
            actionsBar.querySelector('[title="Save to Private Gallery"]').addEventListener('click', (e) => { e.stopPropagation(); saveImageToPrivateGallery(e.currentTarget, e.currentTarget.closest('.image-wrapper')); });
            actionsBar.querySelector('[title="Edit Image"]').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                // Pass metadata to editor
                const meta = JSON.parse(e.currentTarget.closest('.image-wrapper').dataset.genOutput || '{}');
                openEditorModalFromButton(e.currentTarget.dataset.imageUrl, meta); 
            });
            actionsBar.querySelector('[title="Delete Image"]').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                e.currentTarget.closest('.image-wrapper').remove(); 
                // REMOVE LOGIC: if(resultsGalleryContainer.children.length===0) placeholder.style.display='flex'; 
            });

            resultsGalleryContainer.prepend(imageWrapper); // Add to start
        }

        async function saveImageToPrivateGallery(button, imageWrapper) {
            try {
                const genOutput = JSON.parse(imageWrapper.dataset.genOutput);
                const id = 'img-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                let imageUrlToSave = genOutput.imageUrl;
                if (imageUrlToSave.startsWith('blob:')) {
                    const response = await fetch(imageUrlToSave);
                    const blob = await response.blob();
                    if (!genOutput.fileSize) genOutput.fileSize = formatBytes(blob.size);
                    imageUrlToSave = await blobToBase64(blob);
                }

                const imageData = {
                    id: id, imageUrl: imageUrlToSave, timestamp: Date.now(), metadata: genOutput
                };

                await addToDB(imageData);
                showToast('Image saved to Private Gallery!', 'success');
                button.disabled = true; 
            } catch (error) { console.error('Error saving image:', error); showToast('Failed to save image.', 'error'); }
        }
        
        function openInfoModal(metadata) {
            infoModalContent.innerHTML = '';
            const createInfoRow = (label, value, isPrompt = false) => {
                if (value === undefined || value === null || value === '') return '';
                if (isPrompt) {
                     return `<div class="info-label" style="display:flex; align-items:center; justify-content:flex-end; gap:6px;">
                                ${label}
                                <i class="fas fa-copy copy-btn" title="Copy Prompt" style="cursor:pointer; color:var(--primary-color);"></i>
                            </div>
                            <div class="info-value prompt-toggle" 
                                    title="Click to expand" 
                                    onclick="this.classList.toggle('expanded')">${value}</div>`;
                }
                return `<div class="info-label">${label}</div><div class="info-value">${value}</div>`;
            };

            const html = `<div class="info-grid">
                    ${createInfoRow('Prompt', metadata.prompt, true)}
                    ${createInfoRow('Model', metadata.model)}
                    ${createInfoRow('File Size', metadata.fileSize || 'Unknown')}
                    ${createInfoRow('Seed', metadata.seed)}
                    ${createInfoRow('Size', `${metadata.width}x${metadata.height}`)}
                    ${createInfoRow('Quality', metadata.quality)}
                    ${createInfoRow('Guidance', metadata.guidance)}
                </div>`;
            infoModalContent.innerHTML = html;
            
            // Attach listener for copy button
            const copyBtn = infoModalContent.querySelector('.copy-btn');
            if(copyBtn) {
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(metadata.prompt).then(() => {
                        showToast('Prompt copied!', 'success');
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        showToast('Failed to copy prompt.', 'error');
                    });
                });
            }
            
            infoModal.classList.add('active');
        }

        function closeInfoModal() { infoModal.classList.remove('active'); }
        
        function openImagePreviewModal(imageUrl) {
            imagePreviewDisplay.src = imageUrl;
            currentPreviewZoom = 1; previewTranslateX = 0; previewTranslateY = 0; updatePreviewTransform();
            imagePreviewModal.classList.add('active');
        }

        function closeImagePreviewModal() {
            imagePreviewModal.classList.remove('active');
            imagePreviewDisplay.src = ''; 
            currentPreviewZoom = 1; previewTranslateX = 0; previewTranslateY = 0; updatePreviewTransform();
        }

        function openEditorModalFromButton(imageUrl, metadata = null) {
            currentFilters = { brightness: 100, contrast: 100, saturation: 100 };
            document.getElementById('edit-brightness').value = 100;
            document.getElementById('edit-contrast').value = 100;
            document.getElementById('edit-saturation').value = 100;
            
            // Store metadata for saving later
            currentEditorMetadata = metadata || {};
            
            editorImage.src = imageUrl;
            editorModal.classList.add('active');
            if (cropper) cropper.destroy();
            cropper = new Cropper(editorImage, {
                viewMode: 1, dragMode: 'move', autoCropArea: 1, responsive: true, background: false,
                ready() { applyFilters(); }
            });
        }

        function handleCloseEditorModal() {
            editorModal.classList.remove('active');
            if (cropper) cropper.destroy();
        }

        function attachFilterListeners() {
            ['brightness', 'contrast', 'saturation'].forEach(type => {
                document.getElementById(`edit-${type}`).addEventListener('input', (e) => {
                    currentFilters[type] = e.target.value;
                    applyFilters();
                });
            });
        }

        function attachEditorToolbarListeners() {
            document.getElementById('btn-zoom-in').onclick = () => cropper.zoom(0.1);
            document.getElementById('btn-zoom-out').onclick = () => cropper.zoom(-0.1);
            document.getElementById('btn-rotate-left').onclick = () => cropper.rotate(-90);
            document.getElementById('btn-rotate-right').onclick = () => cropper.rotate(90);
            document.getElementById('btn-flip-h').onclick = () => { const d = cropper.getData(); cropper.scaleX(d.scaleX === 1 ? -1 : 1); };
            document.getElementById('btn-reset').onclick = () => {
                cropper.reset();
                currentFilters = { brightness: 100, contrast: 100, saturation: 100 };
                document.getElementById('edit-brightness').value = 100;
                document.getElementById('edit-contrast').value = 100;
                document.getElementById('edit-saturation').value = 100;
                applyFilters();
            };
            document.getElementById('btn-download').onclick = () => {
                try {
                    const croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 4096, maxHeight: 4096 });
                    if (!croppedCanvas) { showToast('Error preparing download', 'error'); return; }
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = croppedCanvas.width; finalCanvas.height = croppedCanvas.height;
                    const ctx = finalCanvas.getContext('2d');
                    ctx.filter = `brightness(${currentFilters.brightness}%) contrast(${currentFilters.contrast}%) saturate(${currentFilters.saturation}%)`;
                    ctx.drawImage(croppedCanvas, 0, 0);
                    const link = document.createElement('a');
                    link.download = `imgo-${Date.now()}.png`;
                    link.href = finalCanvas.toDataURL('image/png');
                    link.click();
                    showToast('Download started', 'success');
                } catch (error) { showToast('Download failed', 'error'); }
            };
            
            // SAVE TO GALLERY BUTTON HANDLER
            const saveBtn = document.getElementById('btn-save-edited-gallery');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    try {
                        const croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 4096, maxHeight: 4096 });
                        if (!croppedCanvas) { showToast('Error preparing save', 'error'); return; }
                        
                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = croppedCanvas.width; finalCanvas.height = croppedCanvas.height;
                        const ctx = finalCanvas.getContext('2d');
                        ctx.filter = `brightness(${currentFilters.brightness}%) contrast(${currentFilters.contrast}%) saturate(${currentFilters.saturation}%)`;
                        ctx.drawImage(croppedCanvas, 0, 0);
                        
                        const base64Data = finalCanvas.toDataURL('image/png');
                        const id = 'img-edited-' + Date.now();
                        
                        // Construct metadata for edited image
                        // Append "(Edited)" to prompt if it exists
                        const newMetadata = { ...currentEditorMetadata };
                        if (newMetadata.prompt) {
                            newMetadata.prompt = newMetadata.prompt + ' (Edited)';
                        } else {
                            newMetadata.prompt = 'Edited Image';
                        }
                        // Update dimensions metadata
                        newMetadata.width = finalCanvas.width;
                        newMetadata.height = finalCanvas.height;

                        await addToDB({
                            id: id,
                            imageUrl: base64Data,
                            timestamp: Date.now(),
                            metadata: newMetadata
                        });
                        
                        showToast('Edited image saved to Private Gallery!', 'success');
                    } catch (error) {
                        console.error("Save edited failed:", error);
                        showToast('Failed to save to gallery', 'error');
                    }
                };
            }
        }

        function handleOpenPrivateGalleryModal() {
            closeAllModals();
            privateGalleryModal.classList.add('active');
            headerPrivateGalleryBtn.classList.add('active');
            renderPrivateGalleryImages();
        }

        function handleClosePrivateGalleryModal() {
            privateGalleryModal.classList.remove('active');
            headerPrivateGalleryBtn.classList.remove('active');
        }

        async function renderPrivateGalleryImages() {
            const galleryCanvas = document.getElementById('private-gallery-content');
            if(!galleryCanvas) return;

            galleryCanvas.innerHTML = '<div style="width:100%; text-align:center; padding:20px; color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>'; 
            try {
                await updateStorageInfo();
                const legacyImages = JSON.parse(localStorage.getItem('privateGalleryImages') || '[]');
                const dbImages = await getAllFromDB();
                const allImages = [...dbImages, ...legacyImages];

                galleryCanvas.innerHTML = '';
                if (allImages.length === 0) {
                    const placeholder = document.getElementById('private-gallery-placeholder');
                    if(placeholder) {
                        placeholder.style.display = 'flex';
                        galleryCanvas.appendChild(placeholder);
                    }
                    return;
                } else {
                    const placeholder = document.getElementById('private-gallery-placeholder');
                    if(placeholder) placeholder.style.display = 'none';
                }

                const sortBy = privateGallerySortSelect.value;
                allImages.sort((a, b) => {
                    if (sortBy === 'date_desc') return b.timestamp - a.timestamp;
                    if (sortBy === 'date_asc') return a.timestamp - b.timestamp;
                    return 0;
                });

                allImages.forEach(imageData => {
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'image-wrapper';
                    imageWrapper.dataset.imageId = imageData.id; 
                    imageWrapper.dataset.imageUrl = imageData.imageUrl; 
                    const imgAspectRatio = imageData.metadata.width / imageData.metadata.height;
                    if (imgAspectRatio > 1.2) imageWrapper.dataset.orientation = 'landscape';
                    else if (imgAspectRatio < 0.8) imageWrapper.dataset.orientation = 'portrait';
                    else imageWrapper.dataset.orientation = 'square';

                    const imgElement = document.createElement('img');
                    imgElement.src = imageData.imageUrl;
                    imgElement.alt = imageData.metadata.prompt;
                    imgElement.loading = "lazy";
                    imageWrapper.appendChild(imgElement);
                    imageWrapper.dataset.genOutput = JSON.stringify(imageData.metadata);

                    imageWrapper.addEventListener('click', (e) => openImagePreviewModal(e.currentTarget.dataset.imageUrl));
                    
                    // Onload logic for Olike gallery
                    imgElement.onload = () => {
                        imageWrapper.classList.add('loaded');
                    };
                    if (imgElement.complete) {
                        imageWrapper.classList.add('loaded');
                    }

                    const actionsBar = document.createElement('div');
                    actionsBar.className = 'image-actions-bar'; 
                    actionsBar.innerHTML = `
                        <button class='gallery-action-btn' title="Image Info"><i class="fas fa-info-circle"></i></button>
                        <button class='gallery-action-btn' title="Download Image"><i class="fas fa-download"></i></button>
                        <button class='gallery-action-btn' title="Edit Image" data-image-url="${imageData.imageUrl}"><i class="fas fa-pencil-alt"></i></button>
                        <button class='gallery-action-btn' title="Delete" data-image-id="${imageData.id}"><i class="fas fa-trash"></i></button>
                    `;
                    imageWrapper.appendChild(actionsBar);

                    actionsBar.querySelector('[title="Image Info"]').addEventListener('click', (e) => { e.stopPropagation(); openInfoModal(imageData.metadata); });
                    actionsBar.querySelector('[title="Download Image"]').addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        const link = document.createElement('a');
                        link.download = `imgo-${imageData.id}.png`;
                        link.href = imageData.imageUrl;
                        link.click();
                        showToast('Image downloaded!', 'success');
                    });
                    actionsBar.querySelector('[title="Edit Image"]').addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        // Pass metadata to editor
                        const meta = JSON.parse(e.currentTarget.closest('.image-wrapper').dataset.genOutput || '{}');
                        openEditorModalFromButton(e.currentTarget.dataset.imageUrl, meta); 
                    });
                    actionsBar.querySelector('[title="Delete"]').addEventListener('click', (e) => { e.stopPropagation(); deleteFromPrivateGallery(e.currentTarget.dataset.imageId); });

                    galleryCanvas.appendChild(imageWrapper);
                });
            } catch (e) {
                console.error("Render Gallery Error:", e);
                galleryCanvas.innerHTML = '<div style="padding:20px; color:var(--error);">Error loading gallery.</div>';
            }
        }

        async function deleteFromPrivateGallery(id) {
            if (!confirm('Are you sure you want to delete this image?')) return;
            try {
                await deleteFromDB(id);
                showToast('Image deleted from gallery!', 'success');
                renderPrivateGalleryImages(); 
            } catch (e) {
                console.error("Delete error:", e);
                showToast("Error deleting image", 'error');
            }
        }
        
        // I2P (Image to Prompt) Logic - Sidebar Version
        function selectI2PModel(btn) {
            document.querySelectorAll('#left-i2p-panel .i2p-model-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); currentI2PModel = btn.dataset.model;
        }

        async function handleI2PUploadBtnClick() { imageUploadEl.click(); }

        async function handleI2PUrlBtnClick() {
            const url = prompt("Paste direct image URL (jpg/png):");
            if(url && url.trim().startsWith('http')) {
                currentI2PImageBase64 = url.trim();
                uploadedImageDisplay.src = currentI2PImageBase64;
                uploadedImageDisplay.onerror = () => { showToast("Cannot load image.", 'error'); imagePreviewContainer.style.display='none'; };
                imagePreviewContainer.style.display = 'flex'; 
                showToast('Image URL loaded!', 'normal');
            }
        }

        function processI2PFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentI2PImageBase64 = e.target.result;
                uploadedImageDisplay.src = e.target.result;
                imagePreviewContainer.style.display = 'flex'; 
                showToast('Local image loaded!', 'normal');
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImageWithAI() {
            if (!currentI2PImageBase64) { showToast('No image loaded for analysis.', 'error'); return; }
            if (isProcessingI2P) return;
            
            isProcessingI2P = true; 
            // floatingGenerateBtn.disabled = true; // REMOVED TO ALLOW MULTI-REQUEST
            
            activeGenerationCount++;
            if (loadingStatusText) {
                loadingStatusText.textContent = `Analyzing Image...`;
                loadingStatusText.style.display = 'block';
            }
            loader.style.display = 'block';
            imageToText.value = 'Analyzing...';
            
            abortControllerI2P = new AbortController();
            
            try {
                const payload = { "model": "bidara", "messages": [ { "role": "user", "content": [ { "type": "text", "text": imageToTextInput.value.trim() || "Analyze this image" }, { "type": "image_url", "image_url": { "url": currentI2PImageBase64 } } ] } ], "max_tokens": currentI2PModel === 'fast' ? 600 : 1200, "temperature": currentI2PModel === 'fast' ? 0.7 : 0.8 };
                const response = await fetch("https://text.pollinations.ai/openai", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload), signal: abortControllerI2P.signal });
                if (!response.ok) throw new Error('Analysis failed');
                const data = await response.json();
                imageToText.value = data.choices[0].message.content;
                showToast('Analysis complete!', 'success');
            } catch (error) { 
                if (error.name !== 'AbortError') showToast('Analysis failed.', 'error'); 
                imageToText.value = 'Analysis failed. Please try again.';
            } 
            finally { 
                isProcessingI2P = false; 
                // floatingGenerateBtn.disabled = false; // REMOVED
                
                activeGenerationCount--;
                if(activeGenerationCount <= 0) {
                    loader.style.display = 'none'; 
                    if (loadingStatusText) loadingStatusText.style.display = 'none';
                    activeGenerationCount = 0;
                }
                
                abortControllerI2P = null; 
            }
        }

        function useI2PPrompt() {
            if (imageToText.value.trim()) {
                if(activeTab === 't2i') {
                    inputs.prompt.value = imageToText.value;
                    switchTab('t2i');
                } else if(activeTab === 'i2i') {
                    inputs.i2iPromptInput.value = imageToText.value;
                    switchTab('i2i');
                } else {
                    // If staying on I2P or if user clicked it, default to T2I
                    inputs.prompt.value = imageToText.value;
                    switchTab('t2i');
                }
                saveConfig(); 
                showToast('Prompt copied to generator!', 'success'); 
            }
        }
        
        // I2I Input Logic (Migrated)
        function handleAddI2IImage(url) {
            i2iInputImages.push(url);
            updateI2IGalleryUI();
            saveConfig();
        }
        
        function handleRemoveI2IImage(index) {
            i2iInputImages.splice(index, 1);
            updateI2IGalleryUI();
            saveConfig();
        }
        
        function updateI2IGalleryUI() {
             i2iInputGallery.innerHTML = '';
             if (i2iInputImages.length === 0) {
                 i2iEmptyPlaceholder.style.display = 'block';
                 i2iInputGallery.style.display = 'none';
                 if(clearI2IInputBtn) clearI2IInputBtn.style.display = 'none';
             } else {
                 i2iEmptyPlaceholder.style.display = 'none';
                 i2iInputGallery.style.display = 'flex';
                 if(clearI2IInputBtn) clearI2IInputBtn.style.display = 'flex';
                 i2iInputImages.forEach((imgSrc, idx) => {
                     const item = document.createElement('div');
                     item.className = 'i2i-image-item';
                     const img = document.createElement('img'); img.src = imgSrc;
                     const removeBtn = document.createElement('button');
                     removeBtn.className = 'i2i-remove-btn'; removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                     removeBtn.onclick = (e) => { e.stopPropagation(); handleRemoveI2IImage(idx); };
                     item.appendChild(img); item.appendChild(removeBtn);
                     i2iInputGallery.appendChild(item);
                 });
             }
        }

        async function handleI2IUrlBtnClick() {
            const url = prompt("Paste direct image URL:");
            if (url && url.trim().startsWith('http')) {
                handleAddI2IImage(url.trim());
                showToast('URL added!', 'normal');
            }
        }
        
        function handleClearI2IInput() {
            i2iInputImages = []; updateI2IGalleryUI(); saveConfig();
        }

        async function sendImageToI2I(imageUrl, promptText) {
            try {
                let processedImageUrl = imageUrl;
                if (imageUrl.startsWith('blob:')) {
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    processedImageUrl = await blobToBase64(blob);
                }
                handleAddI2IImage(processedImageUrl);
                if (i2iPromptInput) i2iPromptInput.value = promptText || '';
                switchTab('i2i');
                showToast('Image sent to I2I sidebar!', 'success');
            } catch (e) { showToast("Failed to send to I2I.", 'error'); }
        }

        function closeAllModals() {
            privateGalleryModal.classList.remove('active'); headerPrivateGalleryBtn.classList.remove('active');
            infoModal.classList.remove('active');
        }

        function attachKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (editorModal.classList.contains('active')) handleCloseEditorModal();
                    else if (imagePreviewModal.classList.contains('active')) closeImagePreviewModal();
                    else closeAllModals();
                }
                if (e.key === 'Enter' && !e.target.matches('textarea') && !e.target.matches('input') && !e.target.matches('button')) {
                    if (inputs.prompt.value.trim() || inputs.i2iPromptInput.value.trim()) floatingGenerateBtn.click();
                }
            });
        }
        
        // ===== MIXER 3.0 LOGIC =====
        function initNsfwMixer() {
            nsfwMixerToggle = document.getElementById('nsfw_mixer_toggle');
            nsfwCategorySelect = document.getElementById('nsfw-category-select');
            nsfwOptionsList = document.getElementById('nsfw-options-list');
            nsfwSelectedList = document.getElementById('nsfw-selected-list');
            nsfwMixerGroup = document.getElementById('nsfw-mixer-group');
            nsfwMixerContent = document.getElementById('nsfw-mixer-content');

            // --- Updated Logic to check for global stylesNsfw (Perchance List or Window Property) ---
            let data = null;
            
            // Cek apakah ada sebagai variabel global langsung (tanpa window.)
            if (typeof stylesNsfw !== 'undefined') {
                if (typeof stylesNsfw === 'function') {
                    data = stylesNsfw();
                } else if (Array.isArray(stylesNsfw)) {
                    data = stylesNsfw;
                }
            } 
            // Fallback: Cek di properti window
            else if (typeof window.stylesNsfw !== 'undefined') {
                if (typeof window.stylesNsfw === 'function') {
                    data = window.stylesNsfw();
                } else if (Array.isArray(window.stylesNsfw)) {
                    data = window.stylesNsfw;
                }
            }

            if(data && Array.isArray(data) && nsfwCategorySelect) {
                nsfwCategorySelect.innerHTML = '<option value="">Select Category...</option>';
                data.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.value;
                    opt.textContent = cat.name;
                    nsfwCategorySelect.appendChild(opt);
                });
                
                nsfwCategorySelect.addEventListener('change', () => {
                   const val = nsfwCategorySelect.value;
                   nsfwOptionsList.innerHTML = '';
                   const catData = data.find(c => c.value === val);
                   if(catData && catData.subOptions) {
                       catData.subOptions.forEach(sub => {
                           const tag = document.createElement('div');
                           tag.className = 'mixer-tag';
                           tag.textContent = sub.name;
                           tag.dataset.value = sub.value;
                           tag.onclick = () => addNsfwItem(sub.name, sub.value);
                           nsfwOptionsList.appendChild(tag);
                       });
                   } else {
                       nsfwOptionsList.innerHTML = '<div class="mixer-empty-text">Select a category...</div>';
                   }
                });
            } else if (nsfwOptionsList) {
                nsfwOptionsList.innerHTML = '<div class="mixer-empty-text">Plugin stylesNsfw not loaded. Check import.</div>';
            }
        }
        
        function toggleMixerDisplay(isChecked) {
            if(nsfwMixerContent) nsfwMixerContent.style.display = isChecked ? 'flex' : 'none';
        }
        
        function addNsfwItem(name, value) {
            // Prevent duplicates
            const existing = Array.from(nsfwSelectedList.children).find(el => el.dataset.value === value);
            if(existing) return;
            
            const tag = document.createElement('div');
            tag.className = 'mixer-tag selected-item';
            tag.dataset.value = value;
            tag.innerHTML = `<span>${name}</span><i class="fas fa-times"></i>`;
            tag.onclick = function() {
                this.remove();
                saveConfig();
            };
            nsfwSelectedList.appendChild(tag);
            saveConfig();
        }

        // ===== MIXER 4.0 LOGIC (VIEW PRESET) =====
        function initMixer4() {
            mix4MixerToggle = document.getElementById('mix4_mixer_toggle');
            mix4CategorySelect = document.getElementById('mix4-category-select');
            mix4OptionsList = document.getElementById('mix4-options-list');
            mix4SelectedList = document.getElementById('mix4-selected-list');
            mix4MixerGroup = document.getElementById('mix4-mixer-group');
            mix4MixerContent = document.getElementById('mix4-mixer-content');

            // Logic to check for global stylesMix (Perchance List or Window Property)
            let data = null;
            
            // Check stylesMix variable
            if (typeof stylesMix !== 'undefined') {
                if (typeof stylesMix === 'function') data = stylesMix();
                else if (Array.isArray(stylesMix)) data = stylesMix;
            } 
            // Fallback: Check window property
            else if (typeof window.stylesMix !== 'undefined') {
                if (typeof window.stylesMix === 'function') data = window.stylesMix();
                else if (Array.isArray(window.stylesMix)) data = window.stylesMix;
            }

            if(data && Array.isArray(data) && mix4CategorySelect) {
                mix4CategorySelect.innerHTML = '<option value="">Select View...</option>';
                data.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.value;
                    opt.textContent = cat.name;
                    mix4CategorySelect.appendChild(opt);
                });
                
                mix4CategorySelect.addEventListener('change', () => {
                   const val = mix4CategorySelect.value;
                   mix4OptionsList.innerHTML = '';
                   const catData = data.find(c => c.value === val);
                   if(catData && catData.subOptions) {
                       catData.subOptions.forEach(sub => {
                           const tag = document.createElement('div');
                           tag.className = 'mixer-tag';
                           tag.textContent = sub.name;
                           tag.dataset.value = sub.value;
                           tag.onclick = () => addMix4Item(sub.name, sub.value);
                           mix4OptionsList.appendChild(tag);
                       });
                   } else {
                       mix4OptionsList.innerHTML = '<div class="mixer-empty-text">Select a view category...</div>';
                   }
                });
            } else if (mix4OptionsList) {
                mix4OptionsList.innerHTML = '<div class="mixer-empty-text">Plugin stylesMix not loaded. Check import: {import:olike-mix4}</div>';
            }
        }
        
        function toggleMixer4Display(isChecked) {
            if(mix4MixerContent) mix4MixerContent.style.display = isChecked ? 'flex' : 'none';
        }
        
        function addMix4Item(name, value) {
            // Prevent duplicates
            const existing = Array.from(mix4SelectedList.children).find(el => el.dataset.value === value);
            if(existing) return;
            
            const tag = document.createElement('div');
            tag.className = 'mixer-tag selected-item';
            tag.dataset.value = value;
            tag.innerHTML = `<span>${name}</span><i class="fas fa-times"></i>`;
            tag.onclick = function() {
                this.remove();
                saveConfig();
            };
            mix4SelectedList.appendChild(tag);
            saveConfig();
        }

        window.addEventListener('load', () => {
            try {
                floatingGenerateBtn = document.getElementById('floating-generate-btn');
                resultsGalleryContainer = document.getElementById('results-gallery-container'); 
                loader = document.getElementById('loader');
                loadingStatusText = document.getElementById('loading-status-text');
                placeholder = document.getElementById('placeholder');
                toastContainer = document.getElementById('toast-container');
                headerPrivateGalleryBtn = document.getElementById('header-private-gallery-btn');
                headerLogoBtn = document.getElementById('header-logo-btn'); 
                groundingResults = document.getElementById('grounding-results');
                groundingLinksList = document.getElementById('grounding-links-list');
                pollinationsApiKeyInput = document.getElementById('pollinations-api-key-input');
                themeToggleBtn = document.getElementById('theme-toggle-btn');
                langToggleBtn = document.getElementById('lang-toggle-btn'); // Initialize lang toggle
                refreshBalanceBtn = document.getElementById('refresh-balance-btn');
                
                scrollLeftBtn = document.getElementById('scroll-left');
                scrollRightBtn = document.getElementById('scroll-right');

                imagePreviewModal = document.getElementById('image-preview-modal');
                imagePreviewDisplay = document.getElementById('image-preview-display');
                closeImagePreviewBtn = document.getElementById('close-image-preview');

                editorModal = document.getElementById('editor-modal');
                editorImage = document.getElementById('editor-image');
                closeEditorModalBtn = document.getElementById('close-editor-modal'); 

                privateGalleryModal = document.getElementById('private-gallery-modal');
                privateGalleryContent = document.getElementById('private-gallery-content');
                closePrivateGalleryBtn = document.getElementById('close-private-gallery');
                privateGalleryPlaceholder = document.getElementById('private-gallery-placeholder');
                privateGallerySortSelect = document.getElementById('private-gallery-sort-select'); 
                
                infoModal = document.getElementById('info-modal');
                closeInfoModalBtn = document.getElementById('close-info-modal');
                infoModalContent = document.getElementById('info-modal-content');

                // I2P Elements
                i2pModelFastBtn = document.getElementById('i2p-model-fast-btn');
                i2pModelDetailedBtn = document.getElementById('i2p-model-detailed-btn');
                imageToTextInput = document.getElementById('imageToTextInput');
                i2pUploadBtn = document.getElementById('i2p-upload-btn');
                i2pUrlBtn = document.getElementById('i2p-url-btn');
                imageUploadEl = document.getElementById('imageUploadEl');
                imagePreviewContainer = document.getElementById('imagePreviewContainer');
                uploadedImageDisplay = document.getElementById('uploadedImageDisplay');
                // analyzeBtn (now removed or kept for desktop sidebar? kept inside)
                imageToText = document.getElementById('imageToText');
                usePromptBtn = document.getElementById('usePromptBtn');

                // I2I Elements
                i2iUrlBtn = document.getElementById('i2iUrlBtn');
                i2iPromptInput = document.getElementById('i2iPromptInput');
                i2iModelSelect = document.getElementById('i2i-model-select');
                i2iInputGallery = document.getElementById('i2iInputGallery');
                i2iEmptyPlaceholder = document.getElementById('i2i-empty-placeholder');
                clearI2IInputBtn = document.getElementById('clearI2IInputBtn');
                
                // AI Assistant Elements
                aiGenerateBtn = document.getElementById('ai-generate-btn');
                aiRemixBtn = document.getElementById('ai-remix-btn');
                aiAssistantInput = document.getElementById('ai-assistant-input');
                
                // Tab Elements
                tabT2IBtn = document.getElementById('tab-t2i-btn');
                tabI2IBtn = document.getElementById('tab-i2i-btn');
                tabI2PBtn = document.getElementById('tab-i2p-btn');
                
                // Init New Modal Inputs
                i2iAspectRatio = document.getElementById('i2i-aspect-ratio');
                i2iQuality = document.getElementById('i2i-quality');
                i2iGuidance = document.getElementById('i2i-guidance');
                i2iSeed = document.getElementById('i2i-seed');
                i2iRandomSeedBtn = document.getElementById('i2i-random-seed-btn');
                i2iGuidanceVal = document.getElementById('i2i-guidance-val');
                i2iNegPromptInput = document.getElementById('i2iNegPromptInput');
                
                // Mixer Elements (INIT DISINI AGAR AMAN)
                nsfwMixerToggle = document.getElementById('nsfw_mixer_toggle');
                nsfwCategorySelect = document.getElementById('nsfw-category-select');
                nsfwOptionsList = document.getElementById('nsfw-options-list');
                nsfwSelectedList = document.getElementById('nsfw-selected-list');
                nsfwMixerGroup = document.getElementById('nsfw-mixer-group');
                nsfwMixerContent = document.getElementById('nsfw-mixer-content');
                
                // Mixer 4.0 Elements
                mix4MixerToggle = document.getElementById('mix4_mixer_toggle');
                mix4CategorySelect = document.getElementById('mix4-category-select');
                mix4OptionsList = document.getElementById('mix4-options-list');
                mix4SelectedList = document.getElementById('mix4-selected-list');
                mix4MixerGroup = document.getElementById('mix4-mixer-group');
                mix4MixerContent = document.getElementById('mix4-mixer-content');
                
                // SIDEBAR TOGGLES
                toggleLeftSidebarBtn = document.getElementById('toggle-left-sidebar');
                toggleRightSidebarBtn = document.getElementById('toggle-right-sidebar');
                sidebarLeft = document.getElementById('sidebar-left');
                sidebarRight = document.getElementById('sidebar-right');
                
                if(toggleLeftSidebarBtn && sidebarLeft) {
                    toggleLeftSidebarBtn.addEventListener('click', () => {
                        sidebarLeft.classList.toggle('hidden');
                        toggleLeftSidebarBtn.classList.toggle('active');
                        // Add class to body to manage center layout
                        document.body.classList.toggle('left-closed');
                    });
                }
                
                if(toggleRightSidebarBtn && sidebarRight) {
                    toggleRightSidebarBtn.addEventListener('click', () => {
                        sidebarRight.classList.toggle('hidden');
                        toggleRightSidebarBtn.classList.toggle('active');
                        // Add class to body to manage center layout
                        document.body.classList.toggle('right-closed');
                    });
                }
                
                if(i2iGuidance) {
                    i2iGuidance.addEventListener('input', (e) => {
                       if(i2iGuidanceVal) i2iGuidanceVal.textContent = e.target.value; 
                    });
                }
                if(i2iRandomSeedBtn) {
                    i2iRandomSeedBtn.addEventListener('click', () => {
                        const rnd = Math.floor(Math.random() * 999999999);
                        if(i2iSeed) i2iSeed.value = rnd;
                    });
                }

                inputs = {
                    prompt: document.getElementById('prompt'),
                    negPrompt: document.getElementById('negative_prompt'),
                    aspectRatio: document.getElementById('aspect-ratio'), 
                    width: document.getElementById('width'),
                    height: document.getElementById('height'),
                    imageModelSelect: document.getElementById('image-model-select'),
                    quality: document.getElementById('quality'),
                    guidance: document.getElementById('guidance'),
                    seed: document.getElementById('seed'),
                    numImages: document.getElementById('num_images'),
                    enhanceToggle: document.getElementById('enhance_toggle'),
                    nsfwToggle: document.getElementById('nsfw_toggle'),
                    nsfwStrength: document.getElementById('nsfw_strength'),
                    pollinationsApiKeyInput: document.getElementById('pollinations-api-key-input'),
                    i2iPromptInput: document.getElementById('i2iPromptInput'),
                    i2iNegPromptInput: document.getElementById('i2iNegPromptInput'),
                    i2iModelSelect: document.getElementById('i2i-model-select'),
                    i2iQuality: document.getElementById('i2i-quality'),
                    randomSeedBtn: document.getElementById('random-seed-btn'),
                    // Mixer Input Reference
                    nsfwMixerToggle: document.getElementById('nsfw_mixer_toggle'),
                    // Mixer 4 Input Reference
                    mix4MixerToggle: document.getElementById('mix4_mixer_toggle')
                };

                displays = {
                    width: document.getElementById('width-display'),
                    height: document.getElementById('height-display'),
                    guidance: document.getElementById('guidance-display'),
                    nsfwStrength: document.getElementById('nsfw-strength-display')
                };
                
                // Add tiny delay to ensure Perchance lists are populated in global scope
                setTimeout(() => {
                    initNsfwMixer();
                    initMixer4(); // Init Mixer 4.0
                }, 100);

                attachInputListeners();
                attachFilterListeners();
                attachEditorToolbarListeners();
                attachKeyboardShortcuts();

                if(scrollLeftBtn) scrollLeftBtn.addEventListener('click', () => { resultsGalleryContainer.scrollBy({ left: -300, behavior: 'smooth' }); });
                if(scrollRightBtn) scrollRightBtn.addEventListener('click', () => { resultsGalleryContainer.scrollBy({ left: 300, behavior: 'smooth' }); });

                if(i2iUrlBtn) i2iUrlBtn.addEventListener('click', handleI2IUrlBtnClick);
                
                if(clearI2IInputBtn) clearI2IInputBtn.addEventListener('click', handleClearI2IInput);

                if (headerPrivateGalleryBtn) headerPrivateGalleryBtn.addEventListener('click', handleOpenPrivateGalleryModal);
                if (closePrivateGalleryBtn) closePrivateGalleryBtn.addEventListener('click', handleClosePrivateGalleryModal);
                
                if (headerLogoBtn) headerLogoBtn.addEventListener('click', () => closeAllModals());
                if (themeToggleBtn) themeToggleBtn.addEventListener('click', handleThemeToggle);
                if (langToggleBtn) langToggleBtn.addEventListener('click', handleLangToggle); // Attach language toggle
                if (refreshBalanceBtn) refreshBalanceBtn.addEventListener('click', fetchPollenBalance);

                if (floatingGenerateBtn) floatingGenerateBtn.addEventListener('click', handleGenerateButtonClick);

                // TAB EVENT LISTENERS
                if (tabT2IBtn) tabT2IBtn.addEventListener('click', () => switchTab('t2i'));
                if (tabI2IBtn) tabI2IBtn.addEventListener('click', () => switchTab('i2i'));
                if (tabI2PBtn) tabI2PBtn.addEventListener('click', () => switchTab('i2p'));

                if (i2pModelFastBtn) i2pModelFastBtn.addEventListener('click', function() { selectI2PModel(this); });
                if (i2pModelDetailedBtn) i2pModelDetailedBtn.addEventListener('click', function() { selectI2PModel(this); });
                if (i2pUploadBtn) i2pUploadBtn.addEventListener('click', handleI2PUploadBtnClick);
                if (i2pUrlBtn) i2pUrlBtn.addEventListener('click', handleI2PUrlBtnClick);
                if (imageUploadEl) imageUploadEl.addEventListener('change', (e) => { if(e.target.files[0]) processI2PFile(e.target.files[0]); });
                // Note: analyzeBtn removed from logic in favor of floating button, but kept analyzeImageWithAI logic available
                if (usePromptBtn) usePromptBtn.addEventListener('click', useI2PPrompt);

                if (closeImagePreviewBtn) closeImagePreviewBtn.addEventListener('click', closeImagePreviewModal);
                if (imagePreviewModal) imagePreviewModal.addEventListener('click', (e) => { if (e.target === imagePreviewModal || e.target.classList.contains('modal-content-wrapper')) closeImagePreviewModal(); });
                
                if (imagePreviewDisplay) {
                    imagePreviewDisplay.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        if (e.deltaY < 0) currentPreviewZoom += 0.1; else currentPreviewZoom -= 0.1;
                        if (currentPreviewZoom < 0.1) currentPreviewZoom = 0.1;
                        if (currentPreviewZoom > 5) currentPreviewZoom = 5;
                        if (currentPreviewZoom <= 1) { currentPreviewZoom = 1; previewTranslateX = 0; previewTranslateY = 0; }
                        updatePreviewTransform();
                    });
                    imagePreviewDisplay.addEventListener('mousedown', (e) => {
                        if (currentPreviewZoom > 1) { isDraggingPreview = true; previewStartX = e.clientX - previewTranslateX; previewStartY = e.clientY - previewTranslateY; imagePreviewDisplay.classList.add('grabbing'); e.preventDefault(); }
                    });
                    window.addEventListener('mousemove', (e) => {
                        if (isDraggingPreview) { e.preventDefault(); previewTranslateX = e.clientX - previewStartX; previewTranslateY = e.clientY - previewStartY; updatePreviewTransform(); }
                    });
                    window.addEventListener('mouseup', () => { if (isDraggingPreview) { isDraggingPreview = false; imagePreviewDisplay.classList.remove('grabbing'); } });
                    imagePreviewDisplay.addEventListener('touchstart', (e) => {
                        if (e.touches.length === 1 && currentPreviewZoom > 1) { isDraggingPreview = true; previewStartX = e.touches[0].clientX - previewTranslateX; previewStartY = e.touches[0].clientY - previewTranslateY; }
                    });
                    window.addEventListener('touchmove', (e) => {
                        if (isDraggingPreview && e.touches.length === 1) { e.preventDefault(); previewTranslateX = e.touches[0].clientX - previewTranslateX; previewTranslateY = e.touches[0].clientY - previewTranslateY; updatePreviewTransform(); }
                    }, { passive: false });
                    window.addEventListener('touchend', () => { isDraggingPreview = false; });
                }

                if (closeEditorModalBtn) closeEditorModalBtn.addEventListener('click', handleCloseEditorModal);
                if (closeInfoModalBtn) closeInfoModalBtn.addEventListener('click', closeInfoModal);
                if (privateGallerySortSelect) privateGallerySortSelect.addEventListener('change', renderPrivateGalleryImages);
                
                // AI Assistant & Remix Logic
                if (aiGenerateBtn && aiAssistantInput && inputs.prompt) {
                    aiGenerateBtn.addEventListener('click', async () => {
                        const instructionText = aiAssistantInput.value.trim();
                        if (!instructionText) { 
                            showToast('Please describe the image first', 'warning'); 
                            aiAssistantInput.focus();
                            return; 
                        }
                        
                        // FIX: Check environment (Local window OR Parent window for Perchance iframe)
                        let aiEngine = null;
                        // 1. Try local window first
                        if (typeof generateText === 'function') {
                            aiEngine = generateText;
                        } 
                        // 2. Try window.generateText explicitly
                        else if (typeof window.generateText === 'function') {
                            aiEngine = window.generateText;
                        }
                        // 3. Try root (Perchance module context)
                        else if (typeof root !== 'undefined' && typeof root.generateText === 'function') {
                            aiEngine = root.generateText;
                        }
                        // 4. Try parent window (only if safe, wrapped in try-catch)
                        else {
                            try {
                                if (window.parent && typeof window.parent.generateText === 'function') {
                                    aiEngine = window.parent.generateText;
                                }
                            } catch (e) {
                                // CORS Error jika di iframe beda domain, abaikan
                                console.log("Parent access blocked (CORS).");
                            }
                        }

                        if (!aiEngine) {
                            showToast('Perchance AI engine not detected.', 'error');
                            console.error("Plugin 'text-generation-plugin' not found in window or window.parent");
                            return;
                        }

                        aiGenerateBtn.disabled = true;
                        const originalIcon = aiGenerateBtn.innerHTML;
                        aiGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        // Clear prompt first
                        inputs.prompt.value = ""; 
                        
                        try {
                            // Call the detected AI Engine
                            await aiEngine({
                                instruction: `Description: The image shows ${instructionText}`, 
                                startWith: `Description: The image shows`, 
                                stopSequences: ["\n"], 
                                hideStartWith: true,
                                onChunk: (data) => { 
                                    // Streaming update
                                    inputs.prompt.value += data.textChunk;
                                    // Auto-scroll to bottom of textarea
                                    inputs.prompt.scrollTop = inputs.prompt.scrollHeight;
                                }
                            });
                            
                            saveConfig(); 
                            showToast('Prompt generated by AI!', 'success');
                        } catch (e) {
                            console.error("AI Gen Error:", e);
                            showToast('AI Generation failed. Check console.', 'error');
                        } finally {
                            aiGenerateBtn.disabled = false;
                            aiGenerateBtn.innerHTML = originalIcon;
                        }
                    });
                }
                
                if (aiRemixBtn && inputs.prompt) {
                    aiRemixBtn.addEventListener('click', () => {
                        const text = inputs.prompt.value.trim();
                        if (!text) { showToast('Prompt is empty', 'warning'); return; }
                        
                        // Split by comma, handling potential empty parts
                        let parts = text.split(',').map(s => s.trim()).filter(s => s);
                        
                        if (parts.length < 2) {
                            showToast('Add commas to remix prompt parts', 'warning');
                            return;
                        }
                        
                        // Fisher-Yates Shuffle
                        for (let i = parts.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [parts[i], parts[j]] = [parts[j], parts[i]];
                        }
                        
                        inputs.prompt.value = parts.join(', ');
                        saveConfig();
                        showToast('Prompt Remixed! ', 'success');
                    });
                }

                // Ensure variables are set before loadConfig runs
                loadConfig();
                
                // Initial fetch if key exists
                if(pollinationsApiKeyInput && pollinationsApiKeyInput.value) fetchPollenBalance();
                
                // AUTO-DETECT KEY FROM URL (POLLINATIONS REDIRECT)
                const urlHash = window.location.hash;
                const urlParams = new URLSearchParams(window.location.search);
                let potentialKey = null;

                if (urlHash.includes('key=')) {
                    const match = urlHash.match(/key=([^&]*)/);
                    if (match) potentialKey = match[1];
                } else if (urlParams.has('key')) {
                    potentialKey = urlParams.get('key');
                }

                if (potentialKey && pollinationsApiKeyInput) {
                    pollinationsApiKeyInput.value = potentialKey;
                    saveConfig(); // This will trigger fetchPollenBalance via updateApiStatus if logic is sound, or explicit below
                    updateApiStatus(); 
                    showToast('API Key auto-detected!', 'success');
                    // Clean URL
                    if(history.replaceState) {
                        const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                        window.history.replaceState({path:cleanUrl},'',cleanUrl);
                    }
                }
                
                setInterval(updateCountdownTimer, 1000); updateCountdownTimer(); 
                setInterval(updateRealtimeClock, 1000); updateRealtimeClock();
            } catch (err) { console.error("Init error:", err); showToast("Error initializing.", 'error'); }
        });
    </script>
</body>
</html>
